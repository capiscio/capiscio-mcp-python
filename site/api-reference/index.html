
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Trust badges for MCP tool calls - RFC-006 and RFC-007 implementation.">
      
      
        <meta name="author" content="CapiscIO Team">
      
      
        <link rel="canonical" href="https://docs.capisc.io/mcp/api-reference/">
      
      
        <link rel="prev" href="../guides/mcp-integration/">
      
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>API Reference - capiscio-mcp</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="capiscio-mcp" class="md-header__button md-logo" aria-label="capiscio-mcp" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            capiscio-mcp
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API Reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="cyan"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="cyan"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/capiscio/capiscio-mcp-python" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    capiscio/capiscio-mcp-python
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../getting-started/installation/" class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../guides/server-side/" class="md-tabs__link">
          
  
  
  Guides

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
  
    
  
  API Reference

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="capiscio-mcp" class="md-nav__button md-logo" aria-label="capiscio-mcp" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    capiscio-mcp
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/capiscio/capiscio-mcp-python" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    capiscio/capiscio-mcp-python
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quickstart
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/server-side/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Server-Side (Guarding Tools)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/client-side/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Client-Side (Verifying Servers)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/evidence/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Evidence Logging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/mcp-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MCP SDK Integration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#core-exports" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Exports
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp" class="md-nav__link">
    <span class="md-ellipsis">
      
        capiscio_mcp
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.GuardConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        GuardConfig
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GuardConfig">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.GuardConfig.__post_init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __post_init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.GuardConfig.validate" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.GuardResult" class="md-nav__link">
    <span class="md-ellipsis">
      
        GuardResult
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.GuardError" class="md-nav__link">
    <span class="md-ellipsis">
      
        GuardError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.VerifyConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        VerifyConfig
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.VerifyResult" class="md-nav__link">
    <span class="md-ellipsis">
      
        VerifyResult
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VerifyResult">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.VerifyResult.has_identity" class="md-nav__link">
    <span class="md-ellipsis">
      
        has_identity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.VerifyResult.is_verified" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_verified
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.Decision" class="md-nav__link">
    <span class="md-ellipsis">
      
        Decision
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.AuthLevel" class="md-nav__link">
    <span class="md-ellipsis">
      
        AuthLevel
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.DenyReason" class="md-nav__link">
    <span class="md-ellipsis">
      
        DenyReason
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.ServerState" class="md-nav__link">
    <span class="md-ellipsis">
      
        ServerState
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.ServerErrorCode" class="md-nav__link">
    <span class="md-ellipsis">
      
        ServerErrorCode
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.guard_sync" class="md-nav__link">
    <span class="md-ellipsis">
      
        guard_sync
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.verify_server" class="md-nav__link">
    <span class="md-ellipsis">
      
        verify_server
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.verify_server_sync" class="md-nav__link">
    <span class="md-ellipsis">
      
        verify_server_sync
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#guard-module-rfc-006" class="md-nav__link">
    <span class="md-ellipsis">
      
        Guard Module (RFC-006)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.guard" class="md-nav__link">
    <span class="md-ellipsis">
      
        guard
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.guard--with-full-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        With full configuration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.GuardConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        GuardConfig
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GuardConfig">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.GuardConfig.__post_init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __post_init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.GuardConfig.validate" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.GuardResult" class="md-nav__link">
    <span class="md-ellipsis">
      
        GuardResult
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.guard" class="md-nav__link">
    <span class="md-ellipsis">
      
        guard
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="guard">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.guard--simple-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Simple usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.guard--with-trust-level-requirement" class="md-nav__link">
    <span class="md-ellipsis">
      
        With trust level requirement
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.guard--with-full-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        With full configuration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.guard_sync" class="md-nav__link">
    <span class="md-ellipsis">
      
        guard_sync
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.compute_params_hash" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_params_hash
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server-module-rfc-007" class="md-nav__link">
    <span class="md-ellipsis">
      
        Server Module (RFC-007)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.server" class="md-nav__link">
    <span class="md-ellipsis">
      
        server
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.server.VerifyConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        VerifyConfig
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.server.VerifyResult" class="md-nav__link">
    <span class="md-ellipsis">
      
        VerifyResult
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VerifyResult">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.server.VerifyResult.has_identity" class="md-nav__link">
    <span class="md-ellipsis">
      
        has_identity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.server.VerifyResult.is_verified" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_verified
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.server.verify_server" class="md-nav__link">
    <span class="md-ellipsis">
      
        verify_server
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.server.verify_server_sync" class="md-nav__link">
    <span class="md-ellipsis">
      
        verify_server_sync
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.server.parse_http_headers" class="md-nav__link">
    <span class="md-ellipsis">
      
        parse_http_headers
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.server.parse_jsonrpc_meta" class="md-nav__link">
    <span class="md-ellipsis">
      
        parse_jsonrpc_meta
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="parse_jsonrpc_meta">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.server.parse_jsonrpc_meta--in-mcp-client-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      
        In MCP client initialization
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.server.parse_jsonrpc_meta--for-pop-verification" class="md-nav__link">
    <span class="md-ellipsis">
      
        For PoP verification
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pop-module-key-verification" class="md-nav__link">
    <span class="md-ellipsis">
      
        PoP Module (Key Verification)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.pop" class="md-nav__link">
    <span class="md-ellipsis">
      
        pop
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPRequest" class="md-nav__link">
    <span class="md-ellipsis">
      
        PoPRequest
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PoPRequest">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPRequest.created_datetime" class="md-nav__link">
    <span class="md-ellipsis">
      
        created_datetime
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPRequest.from_meta" class="md-nav__link">
    <span class="md-ellipsis">
      
        from_meta
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPRequest.is_expired" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_expired
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPRequest.to_meta" class="md-nav__link">
    <span class="md-ellipsis">
      
        to_meta
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPResponse" class="md-nav__link">
    <span class="md-ellipsis">
      
        PoPResponse
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PoPResponse">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPResponse.signed_datetime" class="md-nav__link">
    <span class="md-ellipsis">
      
        signed_datetime
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPResponse.from_meta" class="md-nav__link">
    <span class="md-ellipsis">
      
        from_meta
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPResponse.to_meta" class="md-nav__link">
    <span class="md-ellipsis">
      
        to_meta
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPError" class="md-nav__link">
    <span class="md-ellipsis">
      
        PoPError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPSignatureError" class="md-nav__link">
    <span class="md-ellipsis">
      
        PoPSignatureError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPExpiredError" class="md-nav__link">
    <span class="md-ellipsis">
      
        PoPExpiredError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.generate_pop_request" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_pop_request
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.create_pop_response" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_pop_response
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.verify_pop_response" class="md-nav__link">
    <span class="md-ellipsis">
      
        verify_pop_response
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Types
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.types" class="md-nav__link">
    <span class="md-ellipsis">
      
        types
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.types.Decision" class="md-nav__link">
    <span class="md-ellipsis">
      
        Decision
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.types.AuthLevel" class="md-nav__link">
    <span class="md-ellipsis">
      
        AuthLevel
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.types.DenyReason" class="md-nav__link">
    <span class="md-ellipsis">
      
        DenyReason
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.types.ServerState" class="md-nav__link">
    <span class="md-ellipsis">
      
        ServerState
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.types.ServerErrorCode" class="md-nav__link">
    <span class="md-ellipsis">
      
        ServerErrorCode
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.types.TrustLevel" class="md-nav__link">
    <span class="md-ellipsis">
      
        TrustLevel
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.types.CallerCredential" class="md-nav__link">
    <span class="md-ellipsis">
      
        CallerCredential
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CallerCredential">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.types.CallerCredential.auth_level" class="md-nav__link">
    <span class="md-ellipsis">
      
        auth_level
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#errors" class="md-nav__link">
    <span class="md-ellipsis">
      
        Errors
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.errors" class="md-nav__link">
    <span class="md-ellipsis">
      
        errors
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.errors.GuardError" class="md-nav__link">
    <span class="md-ellipsis">
      
        GuardError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.errors.GuardConfigError" class="md-nav__link">
    <span class="md-ellipsis">
      
        GuardConfigError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.errors.ServerVerifyError" class="md-nav__link">
    <span class="md-ellipsis">
      
        ServerVerifyError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.errors.CoreConnectionError" class="md-nav__link">
    <span class="md-ellipsis">
      
        CoreConnectionError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.errors.CoreVersionError" class="md-nav__link">
    <span class="md-ellipsis">
      
        CoreVersionError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mcp-sdk-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        MCP SDK Integration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp" class="md-nav__link">
    <span class="md-ellipsis">
      
        mcp
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient" class="md-nav__link">
    <span class="md-ellipsis">
      
        CapiscioMCPClient
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CapiscioMCPClient">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.is_verified" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_verified
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.pop_verified" class="md-nav__link">
    <span class="md-ellipsis">
      
        pop_verified
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.server_did" class="md-nav__link">
    <span class="md-ellipsis">
      
        server_did
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.server_state" class="md-nav__link">
    <span class="md-ellipsis">
      
        server_state
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.server_trust_level" class="md-nav__link">
    <span class="md-ellipsis">
      
        server_trust_level
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.__aenter__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __aenter__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.__aexit__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __aexit__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.call_tool" class="md-nav__link">
    <span class="md-ellipsis">
      
        call_tool
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.close" class="md-nav__link">
    <span class="md-ellipsis">
      
        close
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.connect" class="md-nav__link">
    <span class="md-ellipsis">
      
        connect
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.create_initialize_request_meta" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_initialize_request_meta
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_initialize_request_meta">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.create_initialize_request_meta--in-your-client-code" class="md-nav__link">
    <span class="md-ellipsis">
      
        In your client code
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.list_tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_tools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.verify_initialize_response" class="md-nav__link">
    <span class="md-ellipsis">
      
        verify_initialize_response
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer" class="md-nav__link">
    <span class="md-ellipsis">
      
        CapiscioMCPServer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CapiscioMCPServer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer--run-the-server" class="md-nav__link">
    <span class="md-ellipsis">
      
        Run the server
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.identity_meta" class="md-nav__link">
    <span class="md-ellipsis">
      
        identity_meta
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.pop_enabled" class="md-nav__link">
    <span class="md-ellipsis">
      
        pop_enabled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.server" class="md-nav__link">
    <span class="md-ellipsis">
      
        server
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.create_initialize_response_meta" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_initialize_response_meta
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_initialize_response_meta">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.create_initialize_response_meta--in-your-initialize-handler" class="md-nav__link">
    <span class="md-ellipsis">
      
        In your initialize handler
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.run_sse" class="md-nav__link">
    <span class="md-ellipsis">
      
        run_sse
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.run_stdio" class="md-nav__link">
    <span class="md-ellipsis">
      
        run_stdio
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.tool" class="md-nav__link">
    <span class="md-ellipsis">
      
        tool
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#core-exports" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Exports
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp" class="md-nav__link">
    <span class="md-ellipsis">
      
        capiscio_mcp
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.GuardConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        GuardConfig
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GuardConfig">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.GuardConfig.__post_init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __post_init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.GuardConfig.validate" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.GuardResult" class="md-nav__link">
    <span class="md-ellipsis">
      
        GuardResult
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.GuardError" class="md-nav__link">
    <span class="md-ellipsis">
      
        GuardError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.VerifyConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        VerifyConfig
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.VerifyResult" class="md-nav__link">
    <span class="md-ellipsis">
      
        VerifyResult
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VerifyResult">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.VerifyResult.has_identity" class="md-nav__link">
    <span class="md-ellipsis">
      
        has_identity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.VerifyResult.is_verified" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_verified
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.Decision" class="md-nav__link">
    <span class="md-ellipsis">
      
        Decision
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.AuthLevel" class="md-nav__link">
    <span class="md-ellipsis">
      
        AuthLevel
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.DenyReason" class="md-nav__link">
    <span class="md-ellipsis">
      
        DenyReason
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.ServerState" class="md-nav__link">
    <span class="md-ellipsis">
      
        ServerState
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.ServerErrorCode" class="md-nav__link">
    <span class="md-ellipsis">
      
        ServerErrorCode
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.guard_sync" class="md-nav__link">
    <span class="md-ellipsis">
      
        guard_sync
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.verify_server" class="md-nav__link">
    <span class="md-ellipsis">
      
        verify_server
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.verify_server_sync" class="md-nav__link">
    <span class="md-ellipsis">
      
        verify_server_sync
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#guard-module-rfc-006" class="md-nav__link">
    <span class="md-ellipsis">
      
        Guard Module (RFC-006)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.guard" class="md-nav__link">
    <span class="md-ellipsis">
      
        guard
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.guard--with-full-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        With full configuration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.GuardConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        GuardConfig
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GuardConfig">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.GuardConfig.__post_init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __post_init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.GuardConfig.validate" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.GuardResult" class="md-nav__link">
    <span class="md-ellipsis">
      
        GuardResult
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.guard" class="md-nav__link">
    <span class="md-ellipsis">
      
        guard
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="guard">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.guard--simple-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Simple usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.guard--with-trust-level-requirement" class="md-nav__link">
    <span class="md-ellipsis">
      
        With trust level requirement
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.guard--with-full-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        With full configuration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.guard_sync" class="md-nav__link">
    <span class="md-ellipsis">
      
        guard_sync
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.guard.compute_params_hash" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_params_hash
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server-module-rfc-007" class="md-nav__link">
    <span class="md-ellipsis">
      
        Server Module (RFC-007)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.server" class="md-nav__link">
    <span class="md-ellipsis">
      
        server
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.server.VerifyConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        VerifyConfig
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.server.VerifyResult" class="md-nav__link">
    <span class="md-ellipsis">
      
        VerifyResult
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VerifyResult">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.server.VerifyResult.has_identity" class="md-nav__link">
    <span class="md-ellipsis">
      
        has_identity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.server.VerifyResult.is_verified" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_verified
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.server.verify_server" class="md-nav__link">
    <span class="md-ellipsis">
      
        verify_server
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.server.verify_server_sync" class="md-nav__link">
    <span class="md-ellipsis">
      
        verify_server_sync
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.server.parse_http_headers" class="md-nav__link">
    <span class="md-ellipsis">
      
        parse_http_headers
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.server.parse_jsonrpc_meta" class="md-nav__link">
    <span class="md-ellipsis">
      
        parse_jsonrpc_meta
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="parse_jsonrpc_meta">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.server.parse_jsonrpc_meta--in-mcp-client-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      
        In MCP client initialization
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.server.parse_jsonrpc_meta--for-pop-verification" class="md-nav__link">
    <span class="md-ellipsis">
      
        For PoP verification
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pop-module-key-verification" class="md-nav__link">
    <span class="md-ellipsis">
      
        PoP Module (Key Verification)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.pop" class="md-nav__link">
    <span class="md-ellipsis">
      
        pop
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPRequest" class="md-nav__link">
    <span class="md-ellipsis">
      
        PoPRequest
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PoPRequest">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPRequest.created_datetime" class="md-nav__link">
    <span class="md-ellipsis">
      
        created_datetime
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPRequest.from_meta" class="md-nav__link">
    <span class="md-ellipsis">
      
        from_meta
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPRequest.is_expired" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_expired
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPRequest.to_meta" class="md-nav__link">
    <span class="md-ellipsis">
      
        to_meta
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPResponse" class="md-nav__link">
    <span class="md-ellipsis">
      
        PoPResponse
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PoPResponse">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPResponse.signed_datetime" class="md-nav__link">
    <span class="md-ellipsis">
      
        signed_datetime
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPResponse.from_meta" class="md-nav__link">
    <span class="md-ellipsis">
      
        from_meta
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPResponse.to_meta" class="md-nav__link">
    <span class="md-ellipsis">
      
        to_meta
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPError" class="md-nav__link">
    <span class="md-ellipsis">
      
        PoPError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPSignatureError" class="md-nav__link">
    <span class="md-ellipsis">
      
        PoPSignatureError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.PoPExpiredError" class="md-nav__link">
    <span class="md-ellipsis">
      
        PoPExpiredError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.generate_pop_request" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_pop_request
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.create_pop_response" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_pop_response
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.pop.verify_pop_response" class="md-nav__link">
    <span class="md-ellipsis">
      
        verify_pop_response
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Types
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.types" class="md-nav__link">
    <span class="md-ellipsis">
      
        types
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.types.Decision" class="md-nav__link">
    <span class="md-ellipsis">
      
        Decision
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.types.AuthLevel" class="md-nav__link">
    <span class="md-ellipsis">
      
        AuthLevel
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.types.DenyReason" class="md-nav__link">
    <span class="md-ellipsis">
      
        DenyReason
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.types.ServerState" class="md-nav__link">
    <span class="md-ellipsis">
      
        ServerState
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.types.ServerErrorCode" class="md-nav__link">
    <span class="md-ellipsis">
      
        ServerErrorCode
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.types.TrustLevel" class="md-nav__link">
    <span class="md-ellipsis">
      
        TrustLevel
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.types.CallerCredential" class="md-nav__link">
    <span class="md-ellipsis">
      
        CallerCredential
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CallerCredential">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.types.CallerCredential.auth_level" class="md-nav__link">
    <span class="md-ellipsis">
      
        auth_level
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#errors" class="md-nav__link">
    <span class="md-ellipsis">
      
        Errors
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.errors" class="md-nav__link">
    <span class="md-ellipsis">
      
        errors
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.errors.GuardError" class="md-nav__link">
    <span class="md-ellipsis">
      
        GuardError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.errors.GuardConfigError" class="md-nav__link">
    <span class="md-ellipsis">
      
        GuardConfigError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.errors.ServerVerifyError" class="md-nav__link">
    <span class="md-ellipsis">
      
        ServerVerifyError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.errors.CoreConnectionError" class="md-nav__link">
    <span class="md-ellipsis">
      
        CoreConnectionError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.errors.CoreVersionError" class="md-nav__link">
    <span class="md-ellipsis">
      
        CoreVersionError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mcp-sdk-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        MCP SDK Integration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp" class="md-nav__link">
    <span class="md-ellipsis">
      
        mcp
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient" class="md-nav__link">
    <span class="md-ellipsis">
      
        CapiscioMCPClient
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CapiscioMCPClient">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.is_verified" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_verified
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.pop_verified" class="md-nav__link">
    <span class="md-ellipsis">
      
        pop_verified
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.server_did" class="md-nav__link">
    <span class="md-ellipsis">
      
        server_did
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.server_state" class="md-nav__link">
    <span class="md-ellipsis">
      
        server_state
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.server_trust_level" class="md-nav__link">
    <span class="md-ellipsis">
      
        server_trust_level
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.__aenter__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __aenter__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.__aexit__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __aexit__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.call_tool" class="md-nav__link">
    <span class="md-ellipsis">
      
        call_tool
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.close" class="md-nav__link">
    <span class="md-ellipsis">
      
        close
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.connect" class="md-nav__link">
    <span class="md-ellipsis">
      
        connect
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.create_initialize_request_meta" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_initialize_request_meta
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_initialize_request_meta">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.create_initialize_request_meta--in-your-client-code" class="md-nav__link">
    <span class="md-ellipsis">
      
        In your client code
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.list_tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_tools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.verify_initialize_response" class="md-nav__link">
    <span class="md-ellipsis">
      
        verify_initialize_response
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer" class="md-nav__link">
    <span class="md-ellipsis">
      
        CapiscioMCPServer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CapiscioMCPServer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer--run-the-server" class="md-nav__link">
    <span class="md-ellipsis">
      
        Run the server
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.identity_meta" class="md-nav__link">
    <span class="md-ellipsis">
      
        identity_meta
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.pop_enabled" class="md-nav__link">
    <span class="md-ellipsis">
      
        pop_enabled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.server" class="md-nav__link">
    <span class="md-ellipsis">
      
        server
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.create_initialize_response_meta" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_initialize_response_meta
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_initialize_response_meta">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.create_initialize_response_meta--in-your-initialize-handler" class="md-nav__link">
    <span class="md-ellipsis">
      
        In your initialize handler
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.run_sse" class="md-nav__link">
    <span class="md-ellipsis">
      
        run_sse
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.run_stdio" class="md-nav__link">
    <span class="md-ellipsis">
      
        run_stdio
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.tool" class="md-nav__link">
    <span class="md-ellipsis">
      
        tool
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="api-reference">API Reference</h1>
<p>This section provides detailed API documentation for all public modules in capiscio-mcp.</p>
<h2 id="core-exports">Core Exports</h2>


<div class="doc doc-object doc-module">



<a id="capiscio_mcp"></a>
    <div class="doc doc-contents first">

        <p>capiscio-mcp: Trust badges for MCP tool calls.</p>
<p>RFC-006: MCP Tool Authority and Evidence
RFC-007: MCP Server Identity Disclosure and Verification</p>
<p>This package provides:
- @guard decorator for protecting MCP tools with trust-level requirements
- Server identity verification for MCP clients
- PoP (Proof of Possession) handshake for server key verification
- Evidence logging for audit and forensics</p>


<details class="installation" open>
  <summary>Installation</summary>
  <p>pip install capiscio-mcp          # Standalone
pip install capiscio-mcp[mcp]     # With MCP SDK integration
pip install capiscio-mcp[crypto]  # With PoP signing/verification</p>
</details>        <p>Quickstart (Server-side):
    from capiscio_mcp import guard</p>
<div class="highlight"><pre><span></span><code>@guard(min_trust_level=2)
async def read_database(query: str) -&gt; list[dict]:
    ...
</code></pre></div>
<p>Quickstart (Client-side):
    from capiscio_mcp import verify_server, ServerState</p>
<div class="highlight"><pre><span></span><code>result = await verify_server(
    server_did=&quot;did:web:mcp.example.com&quot;,
    server_badge=&quot;eyJhbGc...&quot;,
)
if result.state == ServerState.VERIFIED_PRINCIPAL:
    print(f&quot;Trusted at level {result.trust_level}&quot;)
</code></pre></div>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.GuardConfig" class="doc doc-heading">
            <code>GuardConfig</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Configuration for the @guard decorator.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.GuardConfig.min_trust_level">min_trust_level</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum trust level required (0-4, default 0)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.GuardConfig.accept_level_zero">accept_level_zero</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Accept self-signed (did:key) badges</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.GuardConfig.trusted_issuers">trusted_issuers</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of trusted issuer DIDs</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.GuardConfig.allowed_tools">allowed_tools</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Glob patterns for allowed tool names</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.GuardConfig.policy_version">policy_version</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Policy version string for tracking</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.GuardConfig.require_badge">require_badge</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, deny anonymous/API key access</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/guard.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="k">class</span><span class="w"> </span><span class="nc">GuardConfig</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">    Configuration for the @guard decorator.</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        min_trust_level: Minimum trust level required (0-4, default 0)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        accept_level_zero: Accept self-signed (did:key) badges</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">        trusted_issuers: List of trusted issuer DIDs</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">        allowed_tools: Glob patterns for allowed tool names</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">        policy_version: Policy version string for tracking</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">        require_badge: If True, deny anonymous/API key access</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="n">min_trust_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="n">accept_level_zero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="n">trusted_issuers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="n">allowed_tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="n">policy_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="n">require_badge</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate configuration on creation.&quot;&quot;&quot;</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate configuration values.&quot;&quot;&quot;</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="k">raise</span> <span class="n">GuardConfigError</span><span class="p">(</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="sa">f</span><span class="s2">&quot;min_trust_level must be 0-4, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">accept_level_zero</span><span class="p">:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="c1"># Level 0 is self-signed, must explicitly opt-in</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="k">pass</span>  <span class="c1"># This is fine, will deny Level 0 badges</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.GuardConfig.__post_init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__post_init__</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Validate configuration on creation.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/guard.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate configuration on creation.&quot;&quot;&quot;</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.GuardConfig.validate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Validate configuration values.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/guard.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate configuration values.&quot;&quot;&quot;</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="k">raise</span> <span class="n">GuardConfigError</span><span class="p">(</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="sa">f</span><span class="s2">&quot;min_trust_level must be 0-4, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">accept_level_zero</span><span class="p">:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="c1"># Level 0 is self-signed, must explicitly opt-in</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="k">pass</span>  <span class="c1"># This is fine, will deny Level 0 badges</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.GuardResult" class="doc doc-heading">
            <code>GuardResult</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Result from tool access evaluation.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.GuardResult.decision">decision</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Decision (capiscio_mcp.types.Decision)" href="#capiscio_mcp.types.Decision">Decision</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ALLOW or DENY</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.GuardResult.deny_reason">deny_reason</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="DenyReason (capiscio_mcp.types.DenyReason)" href="#capiscio_mcp.types.DenyReason">DenyReason</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reason for denial (if decision is DENY)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.GuardResult.deny_detail">deny_detail</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Human-readable detail (if decision is DENY)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.GuardResult.agent_did">agent_did</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Extracted agent DID from credential</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.GuardResult.badge_jti">badge_jti</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Badge ID if present</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.GuardResult.auth_level">auth_level</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AuthLevel (capiscio_mcp.types.AuthLevel)" href="#capiscio_mcp.types.AuthLevel">AuthLevel</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Authentication level (ANONYMOUS, API_KEY, BADGE)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.GuardResult.trust_level">trust_level</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Verified trust level (0-4)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.GuardResult.evidence_id">evidence_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique evidence record ID</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.GuardResult.evidence_json">evidence_json</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>RFC-006 7 compliant JSON</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/guard.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="k">class</span><span class="w"> </span><span class="nc">GuardResult</span><span class="p">:</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">    Result from tool access evaluation.</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">        decision: ALLOW or DENY</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">        deny_reason: Reason for denial (if decision is DENY)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">        deny_detail: Human-readable detail (if decision is DENY)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">        agent_did: Extracted agent DID from credential</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">        badge_jti: Badge ID if present</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">        auth_level: Authentication level (ANONYMOUS, API_KEY, BADGE)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">        trust_level: Verified trust level (0-4)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">        evidence_id: Unique evidence record ID</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">        evidence_json: RFC-006 7 compliant JSON</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="n">decision</span><span class="p">:</span> <span class="n">Decision</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="n">deny_reason</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DenyReason</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="n">deny_detail</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="c1"># Derived identity</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="n">agent_did</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="n">badge_jti</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="n">auth_level</span><span class="p">:</span> <span class="n">AuthLevel</span> <span class="o">=</span> <span class="n">AuthLevel</span><span class="o">.</span><span class="n">ANONYMOUS</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="n">trust_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="c1"># Evidence</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="n">evidence_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="n">evidence_json</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.GuardError" class="doc doc-heading">
            <code>GuardError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="capiscio_mcp.errors.CapiscioMCPError">CapiscioMCPError</span></code></p>



        <p>Raised when tool access is denied by the guard.</p>
<p>Per RFC-006, all denials include:
- reason: Specific denial reason code
- detail: Human-readable explanation
- evidence_id: ID of the evidence record for audit</p>


<details class="example" open>
  <summary>Example</summary>
  <p>try:
    result = await guarded_tool(params)
except GuardError as e:
    logger.warning(f"Access denied: {e.reason} - {e.detail}")
    logger.info(f"Evidence ID: {e.evidence_id}")</p>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span>
<span class="normal"><a href="#__codelineno-0-92">92</a></span>
<span class="normal"><a href="#__codelineno-0-93">93</a></span>
<span class="normal"><a href="#__codelineno-0-94">94</a></span>
<span class="normal"><a href="#__codelineno-0-95">95</a></span>
<span class="normal"><a href="#__codelineno-0-96">96</a></span>
<span class="normal"><a href="#__codelineno-0-97">97</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="k">class</span><span class="w"> </span><span class="nc">GuardError</span><span class="p">(</span><span class="n">CapiscioMCPError</span><span class="p">):</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">    Raised when tool access is denied by the guard.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    Per RFC-006, all denials include:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">    - reason: Specific denial reason code</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">    - detail: Human-readable explanation</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">    - evidence_id: ID of the evidence record for audit</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">        try:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">            result = await guarded_tool(params)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">        except GuardError as e:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">            logger.warning(f&quot;Access denied: {e.reason} - {e.detail}&quot;)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">            logger.info(f&quot;Evidence ID: {e.evidence_id}&quot;)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="n">reason</span><span class="p">:</span> <span class="s2">&quot;DenyReason&quot;</span><span class="p">,</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="n">detail</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="n">evidence_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="n">agent_did</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="n">trust_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="p">):</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">detail</span> <span class="o">=</span> <span class="n">detail</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">evidence_id</span> <span class="o">=</span> <span class="n">evidence_id</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent_did</span> <span class="o">=</span> <span class="n">agent_did</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trust_level</span> <span class="o">=</span> <span class="n">trust_level</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reason</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">detail</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="k">if</span> <span class="n">evidence_id</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (evidence_id=</span><span class="si">{</span><span class="n">evidence_id</span><span class="si">}</span><span class="s2">)&quot;</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="sa">f</span><span class="s2">&quot;GuardError(reason=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="si">!r}</span><span class="s2">, detail=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">detail</span><span class="si">!r}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="sa">f</span><span class="s2">&quot;evidence_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">evidence_id</span><span class="si">!r}</span><span class="s2">)&quot;</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.VerifyConfig" class="doc doc-heading">
            <code>VerifyConfig</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Configuration for server identity verification.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.VerifyConfig.trusted_issuers">trusted_issuers</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of trusted issuer DIDs</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.VerifyConfig.min_trust_level">min_trust_level</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum trust level required (0-4)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.VerifyConfig.accept_level_zero">accept_level_zero</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Accept self-signed (did:key) servers</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.VerifyConfig.offline_mode">offline_mode</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Skip revocation checks</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.VerifyConfig.skip_origin_binding">skip_origin_binding</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Skip host/path binding checks (for trusted gateways)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/server.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="k">class</span><span class="w"> </span><span class="nc">VerifyConfig</span><span class="p">:</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    Configuration for server identity verification.</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        trusted_issuers: List of trusted issuer DIDs</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        min_trust_level: Minimum trust level required (0-4)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        accept_level_zero: Accept self-signed (did:key) servers</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        offline_mode: Skip revocation checks</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        skip_origin_binding: Skip host/path binding checks (for trusted gateways)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="n">trusted_issuers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="n">min_trust_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="n">accept_level_zero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">offline_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">skip_origin_binding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.VerifyResult" class="doc doc-heading">
            <code>VerifyResult</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Result of server identity verification.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.VerifyResult.state">state</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ServerState (capiscio_mcp.types.ServerState)" href="#capiscio_mcp.types.ServerState">ServerState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server classification state (VERIFIED_PRINCIPAL, DECLARED_PRINCIPAL, UNVERIFIED_ORIGIN)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.VerifyResult.trust_level">trust_level</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Trust level if verified (0-4)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.VerifyResult.server_did">server_did</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server DID if disclosed</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.VerifyResult.badge_jti">badge_jti</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Badge ID if present</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.VerifyResult.error_code">error_code</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ServerErrorCode (capiscio_mcp.types.ServerErrorCode)" href="#capiscio_mcp.types.ServerErrorCode">ServerErrorCode</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Error code if verification failed</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.VerifyResult.error_detail">error_detail</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Human-readable error detail</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/server.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="k">class</span><span class="w"> </span><span class="nc">VerifyResult</span><span class="p">:</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">    Result of server identity verification.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">        state: Server classification state (VERIFIED_PRINCIPAL, DECLARED_PRINCIPAL, UNVERIFIED_ORIGIN)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">        trust_level: Trust level if verified (0-4)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">        server_did: Server DID if disclosed</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">        badge_jti: Badge ID if present</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">        error_code: Error code if verification failed</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">        error_detail: Human-readable error detail</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="n">state</span><span class="p">:</span> <span class="n">ServerState</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="n">trust_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="c1"># Derived identity</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="n">server_did</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="n">badge_jti</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="c1"># Error details</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="n">error_code</span><span class="p">:</span> <span class="n">ServerErrorCode</span> <span class="o">=</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">NONE</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="n">error_detail</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_verified</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if server identity is cryptographically verified.&quot;&quot;&quot;</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">VERIFIED_PRINCIPAL</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">has_identity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if server disclosed any identity.&quot;&quot;&quot;</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">UNVERIFIED_ORIGIN</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="capiscio_mcp.VerifyResult.has_identity" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">has_identity</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Check if server disclosed any identity.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="capiscio_mcp.VerifyResult.is_verified" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_verified</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Check if server identity is cryptographically verified.</p>

    </div>

</div>






  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.Decision" class="doc doc-heading">
            <code>Decision</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="str">str</span></code>, <code><span title="enum.Enum">Enum</span></code></p>



        <p>Tool access decision result.</p>
<p>Per RFC-006 6.3, every tool invocation attempt results in one of:
- ALLOW: Tool execution is permitted
- DENY: Tool execution is blocked with a reason</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/types.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="k">class</span><span class="w"> </span><span class="nc">Decision</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    Tool access decision result.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    Per RFC-006 6.3, every tool invocation attempt results in one of:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    - ALLOW: Tool execution is permitted</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    - DENY: Tool execution is blocked with a reason</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">ALLOW</span> <span class="o">=</span> <span class="s2">&quot;allow&quot;</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">DENY</span> <span class="o">=</span> <span class="s2">&quot;deny&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.AuthLevel" class="doc doc-heading">
            <code>AuthLevel</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="str">str</span></code>, <code><span title="enum.Enum">Enum</span></code></p>



        <p>Caller authentication assurance level.</p>
<p>Per RFC-006 5, every evidence log records the authentication method:
- ANONYMOUS: No identity material provided
- API_KEY: API key authentication (reduced assurance)
- BADGE: CapiscIO Trust Badge authentication (full assurance)</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/types.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="k">class</span><span class="w"> </span><span class="nc">AuthLevel</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    Caller authentication assurance level.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    Per RFC-006 5, every evidence log records the authentication method:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">    - ANONYMOUS: No identity material provided</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    - API_KEY: API key authentication (reduced assurance)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">    - BADGE: CapiscIO Trust Badge authentication (full assurance)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="n">ANONYMOUS</span> <span class="o">=</span> <span class="s2">&quot;anonymous&quot;</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">API_KEY</span> <span class="o">=</span> <span class="s2">&quot;api_key&quot;</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="n">BADGE</span> <span class="o">=</span> <span class="s2">&quot;badge&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.DenyReason" class="doc doc-heading">
            <code>DenyReason</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="str">str</span></code>, <code><span title="enum.Enum">Enum</span></code></p>



        <p>Reason for denying tool access.</p>
<p>Per RFC-006 6.4, denial must include a specific reason code.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/types.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="k">class</span><span class="w"> </span><span class="nc">DenyReason</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">    Reason for denying tool access.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">    Per RFC-006 6.4, denial must include a specific reason code.</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="c1"># Badge issues</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">BADGE_MISSING</span> <span class="o">=</span> <span class="s2">&quot;badge_missing&quot;</span>           <span class="c1"># Required but not provided</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="n">BADGE_INVALID</span> <span class="o">=</span> <span class="s2">&quot;badge_invalid&quot;</span>           <span class="c1"># Malformed or unverifiable</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="n">BADGE_EXPIRED</span> <span class="o">=</span> <span class="s2">&quot;badge_expired&quot;</span>           <span class="c1"># Past expiration time</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="n">BADGE_REVOKED</span> <span class="o">=</span> <span class="s2">&quot;badge_revoked&quot;</span>           <span class="c1"># On revocation list</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="c1"># Trust issues</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="n">TRUST_INSUFFICIENT</span> <span class="o">=</span> <span class="s2">&quot;trust_insufficient&quot;</span> <span class="c1"># Trust level &lt; min required</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="n">ISSUER_UNTRUSTED</span> <span class="o">=</span> <span class="s2">&quot;issuer_untrusted&quot;</span>     <span class="c1"># Issuer not in trusted list</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="c1"># Policy issues</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="n">TOOL_NOT_ALLOWED</span> <span class="o">=</span> <span class="s2">&quot;tool_not_allowed&quot;</span>     <span class="c1"># Tool not in allowed list</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="n">POLICY_DENIED</span> <span class="o">=</span> <span class="s2">&quot;policy_denied&quot;</span>           <span class="c1"># Policy evaluation failed</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="c1"># Other</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="n">INTERNAL_ERROR</span> <span class="o">=</span> <span class="s2">&quot;internal_error&quot;</span>         <span class="c1"># Unexpected error</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.ServerState" class="doc doc-heading">
            <code>ServerState</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="str">str</span></code>, <code><span title="enum.Enum">Enum</span></code></p>



        <p>Server identity verification state.</p>
<p>Per RFC-007 5.2, clients classify servers into three states:</p>
<ul>
<li>
<p>VERIFIED_PRINCIPAL: Server badge verified, trust level established.
  The server has disclosed a DID and a valid badge signed by a trusted issuer.</p>
</li>
<li>
<p>DECLARED_PRINCIPAL: Server DID disclosed but badge missing or invalid.
  Identity is claimed but not cryptographically verified.</p>
</li>
<li>
<p>UNVERIFIED_ORIGIN: Server did not disclose any identity material.
  This is distinct from Trust Level 0 (self-signed) - UNVERIFIED_ORIGIN
  means NO identity was disclosed at all.</p>
</li>
</ul>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/types.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="k">class</span><span class="w"> </span><span class="nc">ServerState</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">    Server identity verification state.</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">    Per RFC-007 5.2, clients classify servers into three states:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">    - VERIFIED_PRINCIPAL: Server badge verified, trust level established.</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">      The server has disclosed a DID and a valid badge signed by a trusted issuer.</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">    - DECLARED_PRINCIPAL: Server DID disclosed but badge missing or invalid.</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">      Identity is claimed but not cryptographically verified.</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">    - UNVERIFIED_ORIGIN: Server did not disclose any identity material.</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">      This is distinct from Trust Level 0 (self-signed) - UNVERIFIED_ORIGIN</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">      means NO identity was disclosed at all.</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="n">VERIFIED_PRINCIPAL</span> <span class="o">=</span> <span class="s2">&quot;verified_principal&quot;</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="n">DECLARED_PRINCIPAL</span> <span class="o">=</span> <span class="s2">&quot;declared_principal&quot;</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="n">UNVERIFIED_ORIGIN</span> <span class="o">=</span> <span class="s2">&quot;unverified_origin&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.ServerErrorCode" class="doc doc-heading">
            <code>ServerErrorCode</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="str">str</span></code>, <code><span title="enum.Enum">Enum</span></code></p>



        <p>Server identity verification error codes.</p>
<p>Per RFC-007 8, verification failures include specific error codes.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/types.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="k">class</span><span class="w"> </span><span class="nc">ServerErrorCode</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">    Server identity verification error codes.</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">    Per RFC-007 8, verification failures include specific error codes.</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>    <span class="n">NONE</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="n">DID_INVALID</span> <span class="o">=</span> <span class="s2">&quot;did_invalid&quot;</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="n">BADGE_INVALID</span> <span class="o">=</span> <span class="s2">&quot;badge_invalid&quot;</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="n">BADGE_EXPIRED</span> <span class="o">=</span> <span class="s2">&quot;badge_expired&quot;</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="n">BADGE_REVOKED</span> <span class="o">=</span> <span class="s2">&quot;badge_revoked&quot;</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="n">TRUST_INSUFFICIENT</span> <span class="o">=</span> <span class="s2">&quot;trust_insufficient&quot;</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="n">ORIGIN_MISMATCH</span> <span class="o">=</span> <span class="s2">&quot;origin_mismatch&quot;</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="n">PATH_MISMATCH</span> <span class="o">=</span> <span class="s2">&quot;path_mismatch&quot;</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="n">ISSUER_UNTRUSTED</span> <span class="o">=</span> <span class="s2">&quot;issuer_untrusted&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="capiscio_mcp.guard_sync" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">guard_sync</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_trust_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tool_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">require_badge</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Sync decorator to guard MCP tool execution.</p>
<p>Same as @guard but for synchronous functions.
Internally runs the async guard in an event loop.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>func</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[<span title="capiscio_mcp.guard.P">P</span>, <span title="capiscio_mcp.guard.R">R</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function to decorate (if called without parentheses)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="GuardConfig


  
      dataclass
   (capiscio_mcp.guard.GuardConfig)" href="#capiscio_mcp.guard.GuardConfig">GuardConfig</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Full configuration object</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_trust_level</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Shorthand for config.min_trust_level</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tool_name</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Override tool name (default: function name)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>require_badge</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, deny anonymous/API key access</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>@guard_sync(min_trust_level=2)
def read_file(path: str) -&gt; str:
    ...</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/guard.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-454" name="__codelineno-0-454"></a><span class="k">def</span><span class="w"> </span><span class="nf">guard_sync</span><span class="p">(</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>    <span class="n">func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GuardConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>    <span class="n">min_trust_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>    <span class="n">tool_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>    <span class="n">require_badge</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">],</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">]],</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">]]]:</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a><span class="sd">    Sync decorator to guard MCP tool execution.</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a><span class="sd">    Same as @guard but for synchronous functions.</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a><span class="sd">    Internally runs the async guard in an event loop.</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="sd">        func: Function to decorate (if called without parentheses)</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a><span class="sd">        config: Full configuration object</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a><span class="sd">        min_trust_level: Shorthand for config.min_trust_level</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a><span class="sd">        tool_name: Override tool name (default: function name)</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a><span class="sd">        require_badge: If True, deny anonymous/API key access</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a><span class="sd">        @guard_sync(min_trust_level=2)</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a><span class="sd">        def read_file(path: str) -&gt; str:</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a><span class="sd">            ...</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">make_decorator</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">]:</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>        <span class="c1"># Build effective config</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>        <span class="n">effective_config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">GuardConfig</span><span class="p">()</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>        <span class="k">if</span> <span class="n">min_trust_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>            <span class="n">effective_config</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">=</span> <span class="n">min_trust_level</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>        <span class="k">if</span> <span class="n">require_badge</span><span class="p">:</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>            <span class="n">effective_config</span><span class="o">.</span><span class="n">require_badge</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>        <span class="n">effective_tool_name</span> <span class="o">=</span> <span class="n">tool_name</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">:</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>            <span class="c1"># Build params dict from kwargs for hashing</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>            <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>            <span class="c1"># Run async evaluation in event loop</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_eval</span><span class="p">():</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>                <span class="k">return</span> <span class="k">await</span> <span class="n">evaluate_tool_access</span><span class="p">(</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>                    <span class="n">tool_name</span><span class="o">=</span><span class="n">effective_tool_name</span><span class="p">,</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>                    <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>                    <span class="n">config</span><span class="o">=</span><span class="n">effective_config</span><span class="p">,</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>                <span class="p">)</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>                <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>                <span class="n">loop</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>            <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>                <span class="c1"># We&#39;re in an async context, use run_coroutine_threadsafe</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>                <span class="kn">import</span><span class="w"> </span><span class="nn">concurrent.futures</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>                <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">run_eval</span><span class="p">(),</span> <span class="n">loop</span><span class="p">)</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">)</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>                <span class="c1"># No event loop, create one</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_eval</span><span class="p">())</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>            <span class="c1"># Check decision</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">decision</span> <span class="o">==</span> <span class="n">Decision</span><span class="o">.</span><span class="n">DENY</span><span class="p">:</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>                <span class="k">raise</span> <span class="n">GuardError</span><span class="p">(</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>                    <span class="n">reason</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">deny_reason</span> <span class="ow">or</span> <span class="n">DenyReason</span><span class="o">.</span><span class="n">INTERNAL_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>                    <span class="n">detail</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">deny_detail</span> <span class="ow">or</span> <span class="s2">&quot;Access denied&quot;</span><span class="p">,</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>                    <span class="n">evidence_id</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">evidence_id</span><span class="p">,</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>                    <span class="n">agent_did</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">agent_did</span><span class="p">,</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>                    <span class="n">trust_level</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">trust_level</span><span class="p">,</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>                <span class="p">)</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>            <span class="c1"># Execute tool</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>        <span class="k">return</span> <span class="n">wrapper</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>    <span class="c1"># Handle both @guard_sync and @guard_sync() syntax</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>    <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>        <span class="k">return</span> <span class="n">make_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>    <span class="k">return</span> <span class="n">make_decorator</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="capiscio_mcp.verify_server" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">verify_server</span><span class="p">(</span><span class="n">server_did</span><span class="p">,</span> <span class="n">server_badge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transport_origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endpoint_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Verify MCP server identity per RFC-007 7.2.</p>
<p>This function implements the client verification algorithm:
1. If no DID disclosed  UNVERIFIED_ORIGIN
2. If DID but no badge  DECLARED_PRINCIPAL
3. If DID + badge  verify badge  VERIFIED_PRINCIPAL or error</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>server_did</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server DID from Capiscio-Server-DID header or _meta</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>server_badge</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server badge JWS from Capiscio-Server-Badge header or _meta</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>transport_origin</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HTTP origin (e.g., "https://mcp.example.com")</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>endpoint_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>URL path for did:web binding (e.g., "/mcp/filesystem")</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="VerifyConfig


  
      dataclass
   (capiscio_mcp.server.VerifyConfig)" href="#capiscio_mcp.server.VerifyConfig">VerifyConfig</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Verification configuration</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="VerifyResult


  
      dataclass
   (capiscio_mcp.server.VerifyResult)" href="#capiscio_mcp.server.VerifyResult">VerifyResult</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>VerifyResult with state, trust_level, and any error details</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>result = await verify_server(
    server_did="did:web:mcp.example.com:servers:filesystem",
    server_badge="eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9...",
    transport_origin="https://mcp.example.com",
)</p>
<p>match result.state:
    case ServerState.VERIFIED_PRINCIPAL:
        print(f"Verified at level {result.trust_level}")
    case ServerState.DECLARED_PRINCIPAL:
        print("Identity claimed but not verified")
    case ServerState.UNVERIFIED_ORIGIN:
        print("No identity disclosed")</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">verify_server</span><span class="p">(</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="n">server_did</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="n">server_badge</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="n">transport_origin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="n">endpoint_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VerifyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VerifyResult</span><span class="p">:</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">    Verify MCP server identity per RFC-007 7.2.</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">    This function implements the client verification algorithm:</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">    1. If no DID disclosed  UNVERIFIED_ORIGIN</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">    2. If DID but no badge  DECLARED_PRINCIPAL</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">    3. If DID + badge  verify badge  VERIFIED_PRINCIPAL or error</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">        server_did: Server DID from Capiscio-Server-DID header or _meta</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">        server_badge: Server badge JWS from Capiscio-Server-Badge header or _meta</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">        transport_origin: HTTP origin (e.g., &quot;https://mcp.example.com&quot;)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">        endpoint_path: URL path for did:web binding (e.g., &quot;/mcp/filesystem&quot;)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="sd">        config: Verification configuration</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">        VerifyResult with state, trust_level, and any error details</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">        result = await verify_server(</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">            server_did=&quot;did:web:mcp.example.com:servers:filesystem&quot;,</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">            server_badge=&quot;eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9...&quot;,</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">            transport_origin=&quot;https://mcp.example.com&quot;,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">        )</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">        match result.state:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">            case ServerState.VERIFIED_PRINCIPAL:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">                print(f&quot;Verified at level {result.trust_level}&quot;)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">            case ServerState.DECLARED_PRINCIPAL:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">                print(&quot;Identity claimed but not verified&quot;)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">            case ServerState.UNVERIFIED_ORIGIN:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">                print(&quot;No identity disclosed&quot;)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">capiscio_mcp._core.client</span><span class="w"> </span><span class="kn">import</span> <span class="n">CoreClient</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="n">effective_config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">VerifyConfig</span><span class="p">()</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="c1"># Quick path: no DID disclosed at all</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">server_did</span><span class="p">:</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Server did not disclose identity (UNVERIFIED_ORIGIN)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="k">return</span> <span class="n">VerifyResult</span><span class="p">(</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="n">state</span><span class="o">=</span><span class="n">ServerState</span><span class="o">.</span><span class="n">UNVERIFIED_ORIGIN</span><span class="p">,</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="n">error_code</span><span class="o">=</span><span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="c1"># Get core client</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">CoreClient</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="c1"># Import proto</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">capiscio_mcp._proto.capiscio.v1</span><span class="w"> </span><span class="kn">import</span> <span class="n">mcp_pb2</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="c1"># Build request</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="n">request</span> <span class="o">=</span> <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">VerifyServerIdentityRequest</span><span class="p">(</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="n">server_did</span><span class="o">=</span><span class="n">server_did</span><span class="p">,</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="n">server_badge</span><span class="o">=</span><span class="n">server_badge</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="n">transport_origin</span><span class="o">=</span><span class="n">transport_origin</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="n">endpoint_path</span><span class="o">=</span><span class="n">endpoint_path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="n">config</span><span class="o">=</span><span class="n">mcp_pb2</span><span class="o">.</span><span class="n">VerifyConfig</span><span class="p">(</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="n">trusted_issuers</span><span class="o">=</span><span class="n">effective_config</span><span class="o">.</span><span class="n">trusted_issuers</span> <span class="ow">or</span> <span class="p">[],</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>            <span class="n">min_trust_level</span><span class="o">=</span><span class="n">effective_config</span><span class="o">.</span><span class="n">min_trust_level</span><span class="p">,</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>            <span class="n">accept_level_zero</span><span class="o">=</span><span class="n">effective_config</span><span class="o">.</span><span class="n">accept_level_zero</span><span class="p">,</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>            <span class="n">offline_mode</span><span class="o">=</span><span class="n">effective_config</span><span class="o">.</span><span class="n">offline_mode</span><span class="p">,</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>            <span class="n">skip_origin_binding</span><span class="o">=</span><span class="n">effective_config</span><span class="o">.</span><span class="n">skip_origin_binding</span><span class="p">,</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="p">),</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>    <span class="p">)</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>    <span class="c1"># Make RPC call</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">stub</span><span class="o">.</span><span class="n">VerifyServerIdentity</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>    <span class="c1"># Map response state</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>    <span class="n">state_map</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">VERIFIED_PRINCIPAL</span><span class="p">:</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">VERIFIED_PRINCIPAL</span><span class="p">,</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">DECLARED_PRINCIPAL</span><span class="p">:</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">DECLARED_PRINCIPAL</span><span class="p">,</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">UNVERIFIED_ORIGIN</span><span class="p">:</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">UNVERIFIED_ORIGIN</span><span class="p">,</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="p">}</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="n">state</span> <span class="o">=</span> <span class="n">state_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">UNVERIFIED_ORIGIN</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="c1"># Map error code</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="n">error_code_map</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">SERVER_ERROR_NONE</span><span class="p">:</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">SERVER_DID_INVALID</span><span class="p">:</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">DID_INVALID</span><span class="p">,</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">SERVER_BADGE_INVALID</span><span class="p">:</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">BADGE_INVALID</span><span class="p">,</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">SERVER_BADGE_EXPIRED</span><span class="p">:</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">BADGE_EXPIRED</span><span class="p">,</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">SERVER_BADGE_REVOKED</span><span class="p">:</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">BADGE_REVOKED</span><span class="p">,</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">SERVER_TRUST_INSUFFICIENT</span><span class="p">:</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">TRUST_INSUFFICIENT</span><span class="p">,</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">SERVER_ORIGIN_MISMATCH</span><span class="p">:</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">ORIGIN_MISMATCH</span><span class="p">,</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">SERVER_PATH_MISMATCH</span><span class="p">:</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">PATH_MISMATCH</span><span class="p">,</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">SERVER_ISSUER_UNTRUSTED</span><span class="p">:</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">ISSUER_UNTRUSTED</span><span class="p">,</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="p">}</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="n">error_code</span> <span class="o">=</span> <span class="n">error_code_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">error_code</span><span class="p">,</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">NONE</span><span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">VerifyResult</span><span class="p">(</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="n">trust_level</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">trust_level</span> <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">trust_level</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="n">server_did</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">server_did</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="n">badge_jti</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">badge_jti</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="n">error_code</span><span class="o">=</span><span class="n">error_code</span><span class="p">,</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="n">error_detail</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">error_detail</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server verification result: state=</span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">, trust_level=</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">trust_level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="capiscio_mcp.verify_server_sync" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">verify_server_sync</span><span class="p">(</span><span class="n">server_did</span><span class="p">,</span> <span class="n">server_badge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transport_origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endpoint_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Sync wrapper for verify_server.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>server_did</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server DID from Capiscio-Server-DID header or _meta</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>server_badge</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server badge JWS from Capiscio-Server-Badge header or _meta</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>transport_origin</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HTTP origin (e.g., "https://mcp.example.com")</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>endpoint_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>URL path for did:web binding</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="VerifyConfig


  
      dataclass
   (capiscio_mcp.server.VerifyConfig)" href="#capiscio_mcp.server.VerifyConfig">VerifyConfig</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Verification configuration</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="VerifyResult


  
      dataclass
   (capiscio_mcp.server.VerifyResult)" href="#capiscio_mcp.server.VerifyResult">VerifyResult</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>VerifyResult with state, trust_level, and any error details</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="k">def</span><span class="w"> </span><span class="nf">verify_server_sync</span><span class="p">(</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="n">server_did</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="n">server_badge</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>    <span class="n">transport_origin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>    <span class="n">endpoint_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VerifyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VerifyResult</span><span class="p">:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="sd">    Sync wrapper for verify_server.</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">        server_did: Server DID from Capiscio-Server-DID header or _meta</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="sd">        server_badge: Server badge JWS from Capiscio-Server-Badge header or _meta</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="sd">        transport_origin: HTTP origin (e.g., &quot;https://mcp.example.com&quot;)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="sd">        endpoint_path: URL path for did:web binding</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">        config: Verification configuration</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="sd">        VerifyResult with state, trust_level, and any error details</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="n">loop</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">concurrent.futures</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="n">verify_server</span><span class="p">(</span><span class="n">server_did</span><span class="p">,</span> <span class="n">server_badge</span><span class="p">,</span> <span class="n">transport_origin</span><span class="p">,</span> <span class="n">endpoint_path</span><span class="p">,</span> <span class="n">config</span><span class="p">),</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>            <span class="n">loop</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="p">)</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="k">return</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">)</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="k">return</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>            <span class="n">verify_server</span><span class="p">(</span><span class="n">server_did</span><span class="p">,</span> <span class="n">server_badge</span><span class="p">,</span> <span class="n">transport_origin</span><span class="p">,</span> <span class="n">endpoint_path</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="guard-module-rfc-006">Guard Module (RFC-006)</h2>


<div class="doc doc-object doc-module">



<a id="capiscio_mcp.guard"></a>
    <div class="doc doc-contents first">

        <p>RFC-006: MCP Tool Authority Guard.</p>
<p>This module provides the @guard decorator for protecting MCP tool execution
with identity verification and policy enforcement.</p>
<p>Key design principle: params_hash is computed in Python, never sent raw to core.
This keeps PII out of the gRPC boundary and avoids cross-language canonicalization.</p>


<details class="usage" open>
  <summary>Usage</summary>
  <p>from capiscio_mcp import guard, GuardConfig</p>
<p>@guard(min_trust_level=2)
async def read_file(path: str) -&gt; str:
    ...</p>
<h2 id="capiscio_mcp.guard--with-full-configuration">With full configuration</h2>
<p>config = GuardConfig(
    min_trust_level=2,
    trusted_issuers=["did:web:registry.capisc.io"],
    allowed_tools=["read_<em>", "list_</em>"],
)</p>
<p>@guard(config=config)
async def execute_query(sql: str) -&gt; list[dict]:
    ...</p>
</details>









<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.guard.GuardConfig" class="doc doc-heading">
            <code>GuardConfig</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Configuration for the @guard decorator.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.guard.GuardConfig.min_trust_level">min_trust_level</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum trust level required (0-4, default 0)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.guard.GuardConfig.accept_level_zero">accept_level_zero</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Accept self-signed (did:key) badges</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.guard.GuardConfig.trusted_issuers">trusted_issuers</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of trusted issuer DIDs</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.guard.GuardConfig.allowed_tools">allowed_tools</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Glob patterns for allowed tool names</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.guard.GuardConfig.policy_version">policy_version</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Policy version string for tracking</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.guard.GuardConfig.require_badge">require_badge</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, deny anonymous/API key access</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/guard.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="k">class</span><span class="w"> </span><span class="nc">GuardConfig</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">    Configuration for the @guard decorator.</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        min_trust_level: Minimum trust level required (0-4, default 0)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        accept_level_zero: Accept self-signed (did:key) badges</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">        trusted_issuers: List of trusted issuer DIDs</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">        allowed_tools: Glob patterns for allowed tool names</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">        policy_version: Policy version string for tracking</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">        require_badge: If True, deny anonymous/API key access</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="n">min_trust_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="n">accept_level_zero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="n">trusted_issuers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="n">allowed_tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="n">policy_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="n">require_badge</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate configuration on creation.&quot;&quot;&quot;</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate configuration values.&quot;&quot;&quot;</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="k">raise</span> <span class="n">GuardConfigError</span><span class="p">(</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="sa">f</span><span class="s2">&quot;min_trust_level must be 0-4, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">accept_level_zero</span><span class="p">:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="c1"># Level 0 is self-signed, must explicitly opt-in</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="k">pass</span>  <span class="c1"># This is fine, will deny Level 0 badges</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.guard.GuardConfig.__post_init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__post_init__</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Validate configuration on creation.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/guard.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate configuration on creation.&quot;&quot;&quot;</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.guard.GuardConfig.validate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Validate configuration values.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/guard.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate configuration values.&quot;&quot;&quot;</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="k">raise</span> <span class="n">GuardConfigError</span><span class="p">(</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="sa">f</span><span class="s2">&quot;min_trust_level must be 0-4, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">accept_level_zero</span><span class="p">:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="c1"># Level 0 is self-signed, must explicitly opt-in</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="k">pass</span>  <span class="c1"># This is fine, will deny Level 0 badges</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.guard.GuardResult" class="doc doc-heading">
            <code>GuardResult</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Result from tool access evaluation.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.guard.GuardResult.decision">decision</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Decision (capiscio_mcp.types.Decision)" href="#capiscio_mcp.types.Decision">Decision</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ALLOW or DENY</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.guard.GuardResult.deny_reason">deny_reason</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="DenyReason (capiscio_mcp.types.DenyReason)" href="#capiscio_mcp.types.DenyReason">DenyReason</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reason for denial (if decision is DENY)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.guard.GuardResult.deny_detail">deny_detail</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Human-readable detail (if decision is DENY)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.guard.GuardResult.agent_did">agent_did</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Extracted agent DID from credential</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.guard.GuardResult.badge_jti">badge_jti</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Badge ID if present</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.guard.GuardResult.auth_level">auth_level</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AuthLevel (capiscio_mcp.types.AuthLevel)" href="#capiscio_mcp.types.AuthLevel">AuthLevel</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Authentication level (ANONYMOUS, API_KEY, BADGE)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.guard.GuardResult.trust_level">trust_level</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Verified trust level (0-4)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.guard.GuardResult.evidence_id">evidence_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique evidence record ID</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.guard.GuardResult.evidence_json">evidence_json</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>RFC-006 7 compliant JSON</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/guard.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="k">class</span><span class="w"> </span><span class="nc">GuardResult</span><span class="p">:</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">    Result from tool access evaluation.</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">        decision: ALLOW or DENY</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">        deny_reason: Reason for denial (if decision is DENY)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">        deny_detail: Human-readable detail (if decision is DENY)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">        agent_did: Extracted agent DID from credential</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">        badge_jti: Badge ID if present</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">        auth_level: Authentication level (ANONYMOUS, API_KEY, BADGE)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">        trust_level: Verified trust level (0-4)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">        evidence_id: Unique evidence record ID</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">        evidence_json: RFC-006 7 compliant JSON</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="n">decision</span><span class="p">:</span> <span class="n">Decision</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="n">deny_reason</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DenyReason</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="n">deny_detail</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="c1"># Derived identity</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="n">agent_did</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="n">badge_jti</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="n">auth_level</span><span class="p">:</span> <span class="n">AuthLevel</span> <span class="o">=</span> <span class="n">AuthLevel</span><span class="o">.</span><span class="n">ANONYMOUS</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="n">trust_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="c1"># Evidence</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="n">evidence_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="n">evidence_json</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="capiscio_mcp.guard.guard" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">guard</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_trust_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tool_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">require_badge</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">guard</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">R</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">R</span><span class="p">]]</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">guard</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GuardConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">min_trust_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">require_badge</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">R</span><span class="p">]]],</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">R</span><span class="p">]]]</span>
</code></pre></div>          </div>


    <div class="doc doc-contents ">

        <p>Async decorator to guard MCP tool execution.</p>
<p>Single RPC call returns decision + evidence atomically.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>func</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[<span title="capiscio_mcp.guard.P">P</span>, <span title="typing.Coroutine">Coroutine</span>[<span title="typing.Any">Any</span>, <span title="typing.Any">Any</span>, <span title="capiscio_mcp.guard.R">R</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function to decorate (if called without parentheses)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="GuardConfig


  
      dataclass
   (capiscio_mcp.guard.GuardConfig)" href="#capiscio_mcp.guard.GuardConfig">GuardConfig</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Full configuration object</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_trust_level</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Shorthand for config.min_trust_level</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tool_name</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Override tool name (default: function name)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>require_badge</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, deny anonymous/API key access</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="typing.Callable">Callable</span>[<span title="capiscio_mcp.guard.P">P</span>, <span title="typing.Coroutine">Coroutine</span>[<span title="typing.Any">Any</span>, <span title="typing.Any">Any</span>, <span title="capiscio_mcp.guard.R">R</span>]], <span title="typing.Callable">Callable</span>[[<span title="typing.Callable">Callable</span>[<span title="capiscio_mcp.guard.P">P</span>, <span title="typing.Coroutine">Coroutine</span>[<span title="typing.Any">Any</span>, <span title="typing.Any">Any</span>, <span title="capiscio_mcp.guard.R">R</span>]]], <span title="typing.Callable">Callable</span>[<span title="capiscio_mcp.guard.P">P</span>, <span title="typing.Coroutine">Coroutine</span>[<span title="typing.Any">Any</span>, <span title="typing.Any">Any</span>, <span title="capiscio_mcp.guard.R">R</span>]]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Decorated function that enforces access control</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <h3 id="capiscio_mcp.guard.guard--simple-usage">Simple usage</h3>
<p>@guard
async def list_files() -&gt; list[str]:
    ...</p>
<h3 id="capiscio_mcp.guard.guard--with-trust-level-requirement">With trust level requirement</h3>
<p>@guard(min_trust_level=2)
async def execute_query(sql: str) -&gt; list[dict]:
    ...</p>
<h3 id="capiscio_mcp.guard.guard--with-full-configuration">With full configuration</h3>
<p>@guard(config=GuardConfig(
    min_trust_level=2,
    trusted_issuers=["did:web:registry.capisc.io"],
))
async def sensitive_operation(data: dict) -&gt; dict:
    ...</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/guard.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="k">def</span><span class="w"> </span><span class="nf">guard</span><span class="p">(</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>    <span class="n">func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">R</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GuardConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>    <span class="n">min_trust_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>    <span class="n">tool_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>    <span class="n">require_badge</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>    <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">R</span><span class="p">]],</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>    <span class="n">Callable</span><span class="p">[[</span><span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">R</span><span class="p">]]],</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">R</span><span class="p">]]],</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a><span class="p">]:</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a><span class="sd">    Async decorator to guard MCP tool execution.</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a><span class="sd">    Single RPC call returns decision + evidence atomically.</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a><span class="sd">        func: Function to decorate (if called without parentheses)</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a><span class="sd">        config: Full configuration object</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a><span class="sd">        min_trust_level: Shorthand for config.min_trust_level</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a><span class="sd">        tool_name: Override tool name (default: function name)</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a><span class="sd">        require_badge: If True, deny anonymous/API key access</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a><span class="sd">        Decorated function that enforces access control</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a><span class="sd">        # Simple usage</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="sd">        @guard</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">        async def list_files() -&gt; list[str]:</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">            ...</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a><span class="sd">        # With trust level requirement</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a><span class="sd">        @guard(min_trust_level=2)</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a><span class="sd">        async def execute_query(sql: str) -&gt; list[dict]:</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a><span class="sd">            ...</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a><span class="sd">        # With full configuration</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a><span class="sd">        @guard(config=GuardConfig(</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="sd">            min_trust_level=2,</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a><span class="sd">            trusted_issuers=[&quot;did:web:registry.capisc.io&quot;],</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a><span class="sd">        ))</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a><span class="sd">        async def sensitive_operation(data: dict) -&gt; dict:</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a><span class="sd">            ...</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">make_decorator</span><span class="p">(</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>        <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">R</span><span class="p">]]</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">R</span><span class="p">]]:</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>        <span class="c1"># Build effective config</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>        <span class="n">effective_config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">GuardConfig</span><span class="p">()</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>        <span class="k">if</span> <span class="n">min_trust_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>            <span class="n">effective_config</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">=</span> <span class="n">min_trust_level</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>        <span class="k">if</span> <span class="n">require_badge</span><span class="p">:</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>            <span class="n">effective_config</span><span class="o">.</span><span class="n">require_badge</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>        <span class="n">effective_tool_name</span> <span class="o">=</span> <span class="n">tool_name</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">:</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>            <span class="c1"># Build params dict from kwargs for hashing</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>            <span class="c1"># Note: args are not included in hash (position-dependent)</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>            <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>            <span class="c1"># Evaluate access</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">evaluate_tool_access</span><span class="p">(</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>                <span class="n">tool_name</span><span class="o">=</span><span class="n">effective_tool_name</span><span class="p">,</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>                <span class="n">config</span><span class="o">=</span><span class="n">effective_config</span><span class="p">,</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>            <span class="p">)</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>            <span class="c1"># Check decision</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">decision</span> <span class="o">==</span> <span class="n">Decision</span><span class="o">.</span><span class="n">DENY</span><span class="p">:</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>                <span class="k">raise</span> <span class="n">GuardError</span><span class="p">(</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>                    <span class="n">reason</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">deny_reason</span> <span class="ow">or</span> <span class="n">DenyReason</span><span class="o">.</span><span class="n">INTERNAL_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>                    <span class="n">detail</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">deny_detail</span> <span class="ow">or</span> <span class="s2">&quot;Access denied&quot;</span><span class="p">,</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>                    <span class="n">evidence_id</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">evidence_id</span><span class="p">,</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>                    <span class="n">agent_did</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">agent_did</span><span class="p">,</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>                    <span class="n">trust_level</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">trust_level</span><span class="p">,</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>                <span class="p">)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>            <span class="c1"># Log successful access</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>                <span class="sa">f</span><span class="s2">&quot;Access allowed for </span><span class="si">{</span><span class="n">effective_tool_name</span><span class="si">}</span><span class="s2">: &quot;</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>                <span class="sa">f</span><span class="s2">&quot;agent=</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">agent_did</span><span class="si">}</span><span class="s2">, trust_level=</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">trust_level</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>            <span class="p">)</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>            <span class="c1"># Execute tool</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>            <span class="k">return</span> <span class="k">await</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>        <span class="k">return</span> <span class="n">wrapper</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>    <span class="c1"># Handle both @guard and @guard() syntax</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>    <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>        <span class="k">return</span> <span class="n">make_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>    <span class="k">return</span> <span class="n">make_decorator</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="capiscio_mcp.guard.guard_sync" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">guard_sync</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_trust_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tool_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">require_badge</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Sync decorator to guard MCP tool execution.</p>
<p>Same as @guard but for synchronous functions.
Internally runs the async guard in an event loop.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>func</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[<span title="capiscio_mcp.guard.P">P</span>, <span title="capiscio_mcp.guard.R">R</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function to decorate (if called without parentheses)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="GuardConfig


  
      dataclass
   (capiscio_mcp.guard.GuardConfig)" href="#capiscio_mcp.guard.GuardConfig">GuardConfig</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Full configuration object</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_trust_level</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Shorthand for config.min_trust_level</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tool_name</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Override tool name (default: function name)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>require_badge</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, deny anonymous/API key access</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>@guard_sync(min_trust_level=2)
def read_file(path: str) -&gt; str:
    ...</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/guard.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-454" name="__codelineno-0-454"></a><span class="k">def</span><span class="w"> </span><span class="nf">guard_sync</span><span class="p">(</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>    <span class="n">func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GuardConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>    <span class="n">min_trust_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>    <span class="n">tool_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>    <span class="n">require_badge</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">],</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">]],</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">]]]:</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a><span class="sd">    Sync decorator to guard MCP tool execution.</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a><span class="sd">    Same as @guard but for synchronous functions.</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a><span class="sd">    Internally runs the async guard in an event loop.</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="sd">        func: Function to decorate (if called without parentheses)</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a><span class="sd">        config: Full configuration object</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a><span class="sd">        min_trust_level: Shorthand for config.min_trust_level</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a><span class="sd">        tool_name: Override tool name (default: function name)</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a><span class="sd">        require_badge: If True, deny anonymous/API key access</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a><span class="sd">        @guard_sync(min_trust_level=2)</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a><span class="sd">        def read_file(path: str) -&gt; str:</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a><span class="sd">            ...</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">make_decorator</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">]:</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>        <span class="c1"># Build effective config</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>        <span class="n">effective_config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">GuardConfig</span><span class="p">()</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>        <span class="k">if</span> <span class="n">min_trust_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>            <span class="n">effective_config</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">=</span> <span class="n">min_trust_level</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>        <span class="k">if</span> <span class="n">require_badge</span><span class="p">:</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>            <span class="n">effective_config</span><span class="o">.</span><span class="n">require_badge</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>        <span class="n">effective_tool_name</span> <span class="o">=</span> <span class="n">tool_name</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">:</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>            <span class="c1"># Build params dict from kwargs for hashing</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>            <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>            <span class="c1"># Run async evaluation in event loop</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_eval</span><span class="p">():</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>                <span class="k">return</span> <span class="k">await</span> <span class="n">evaluate_tool_access</span><span class="p">(</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>                    <span class="n">tool_name</span><span class="o">=</span><span class="n">effective_tool_name</span><span class="p">,</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>                    <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>                    <span class="n">config</span><span class="o">=</span><span class="n">effective_config</span><span class="p">,</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>                <span class="p">)</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>                <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>                <span class="n">loop</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>            <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>                <span class="c1"># We&#39;re in an async context, use run_coroutine_threadsafe</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>                <span class="kn">import</span><span class="w"> </span><span class="nn">concurrent.futures</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>                <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">run_eval</span><span class="p">(),</span> <span class="n">loop</span><span class="p">)</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">)</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>                <span class="c1"># No event loop, create one</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_eval</span><span class="p">())</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>            <span class="c1"># Check decision</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">decision</span> <span class="o">==</span> <span class="n">Decision</span><span class="o">.</span><span class="n">DENY</span><span class="p">:</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>                <span class="k">raise</span> <span class="n">GuardError</span><span class="p">(</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>                    <span class="n">reason</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">deny_reason</span> <span class="ow">or</span> <span class="n">DenyReason</span><span class="o">.</span><span class="n">INTERNAL_ERROR</span><span class="p">,</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>                    <span class="n">detail</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">deny_detail</span> <span class="ow">or</span> <span class="s2">&quot;Access denied&quot;</span><span class="p">,</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>                    <span class="n">evidence_id</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">evidence_id</span><span class="p">,</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>                    <span class="n">agent_did</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">agent_did</span><span class="p">,</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>                    <span class="n">trust_level</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">trust_level</span><span class="p">,</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>                <span class="p">)</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>            <span class="c1"># Execute tool</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>        <span class="k">return</span> <span class="n">wrapper</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>    <span class="c1"># Handle both @guard_sync and @guard_sync() syntax</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>    <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>        <span class="k">return</span> <span class="n">make_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>    <span class="k">return</span> <span class="n">make_decorator</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="capiscio_mcp.guard.compute_params_hash" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_params_hash</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Compute deterministic hash of tool parameters.</p>
<p>CRITICAL: This stays in Python. Core never sees raw params.</p>
<p>Canonicalization rules (JCS-like):
1. Sort keys recursively (lexicographic)
2. Compact JSON (no whitespace)
3. SHA-256 hash
4. Base64url encode (no padding)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>params</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tool parameters dictionary</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String in format "sha256:<base64url>"</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>compute_params_hash({"b": 2, "a": 1})
'sha256:...'  # Same as compute_params_hash({"a": 1, "b": 2})</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/guard.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_params_hash</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">    Compute deterministic hash of tool parameters.</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">    CRITICAL: This stays in Python. Core never sees raw params.</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">    Canonicalization rules (JCS-like):</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">    1. Sort keys recursively (lexicographic)</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">    2. Compact JSON (no whitespace)</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">    3. SHA-256 hash</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">    4. Base64url encode (no padding)</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">        params: Tool parameters dictionary</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">        String in format &quot;sha256:&lt;base64url&gt;&quot;</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">        &gt;&gt;&gt; compute_params_hash({&quot;b&quot;: 2, &quot;a&quot;: 1})</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">        &#39;sha256:...&#39;  # Same as compute_params_hash({&quot;a&quot;: 1, &quot;b&quot;: 2})</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">sort_recursive</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>            <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">sort_recursive</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">())}</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>            <span class="k">return</span> <span class="p">[</span><span class="n">sort_recursive</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">]</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="k">return</span> <span class="n">obj</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>    <span class="n">canonical</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="n">sort_recursive</span><span class="p">(</span><span class="n">params</span><span class="p">),</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">),</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="n">digest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">canonical</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="n">b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;=&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;sha256:</span><span class="si">{</span><span class="n">b64</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="server-module-rfc-007">Server Module (RFC-007)</h2>


<div class="doc doc-object doc-module">



<a id="capiscio_mcp.server"></a>
    <div class="doc doc-contents first">

        <p>RFC-007: MCP Server Identity Verification.</p>
<p>This module provides functions to verify MCP server identity
before establishing trust with the server.</p>
<p>Key distinction from Trust Level 0:
- UNVERIFIED_ORIGIN: Server disclosed NO identity material at all
- Trust Level 0: Server disclosed a self-signed (did:key) identity</p>


<details class="usage" open>
  <summary>Usage</summary>
  <p>from capiscio_mcp import verify_server, ServerState, VerifyConfig</p>
<p>result = await verify_server(
    server_did="did:web:mcp.example.com:servers:filesystem",
    server_badge="eyJhbGc...",
    transport_origin="https://mcp.example.com",
)</p>
<p>if result.state == ServerState.VERIFIED_PRINCIPAL:
    print(f"Server verified at trust level {result.trust_level}")
elif result.state == ServerState.UNVERIFIED_ORIGIN:
    print("Warning: Server did not disclose identity")</p>
</details>









<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.server.VerifyConfig" class="doc doc-heading">
            <code>VerifyConfig</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Configuration for server identity verification.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.server.VerifyConfig.trusted_issuers">trusted_issuers</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of trusted issuer DIDs</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.server.VerifyConfig.min_trust_level">min_trust_level</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum trust level required (0-4)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.server.VerifyConfig.accept_level_zero">accept_level_zero</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Accept self-signed (did:key) servers</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.server.VerifyConfig.offline_mode">offline_mode</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Skip revocation checks</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.server.VerifyConfig.skip_origin_binding">skip_origin_binding</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Skip host/path binding checks (for trusted gateways)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/server.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="k">class</span><span class="w"> </span><span class="nc">VerifyConfig</span><span class="p">:</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    Configuration for server identity verification.</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        trusted_issuers: List of trusted issuer DIDs</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        min_trust_level: Minimum trust level required (0-4)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        accept_level_zero: Accept self-signed (did:key) servers</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        offline_mode: Skip revocation checks</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        skip_origin_binding: Skip host/path binding checks (for trusted gateways)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="n">trusted_issuers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="n">min_trust_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="n">accept_level_zero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">offline_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">skip_origin_binding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.server.VerifyResult" class="doc doc-heading">
            <code>VerifyResult</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Result of server identity verification.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.server.VerifyResult.state">state</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ServerState (capiscio_mcp.types.ServerState)" href="#capiscio_mcp.types.ServerState">ServerState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server classification state (VERIFIED_PRINCIPAL, DECLARED_PRINCIPAL, UNVERIFIED_ORIGIN)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.server.VerifyResult.trust_level">trust_level</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Trust level if verified (0-4)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.server.VerifyResult.server_did">server_did</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server DID if disclosed</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.server.VerifyResult.badge_jti">badge_jti</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Badge ID if present</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.server.VerifyResult.error_code">error_code</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ServerErrorCode (capiscio_mcp.types.ServerErrorCode)" href="#capiscio_mcp.types.ServerErrorCode">ServerErrorCode</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Error code if verification failed</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.server.VerifyResult.error_detail">error_detail</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Human-readable error detail</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/server.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="k">class</span><span class="w"> </span><span class="nc">VerifyResult</span><span class="p">:</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">    Result of server identity verification.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">        state: Server classification state (VERIFIED_PRINCIPAL, DECLARED_PRINCIPAL, UNVERIFIED_ORIGIN)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">        trust_level: Trust level if verified (0-4)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">        server_did: Server DID if disclosed</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">        badge_jti: Badge ID if present</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">        error_code: Error code if verification failed</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">        error_detail: Human-readable error detail</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="n">state</span><span class="p">:</span> <span class="n">ServerState</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="n">trust_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="c1"># Derived identity</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="n">server_did</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="n">badge_jti</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="c1"># Error details</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="n">error_code</span><span class="p">:</span> <span class="n">ServerErrorCode</span> <span class="o">=</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">NONE</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="n">error_detail</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_verified</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if server identity is cryptographically verified.&quot;&quot;&quot;</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">VERIFIED_PRINCIPAL</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">has_identity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if server disclosed any identity.&quot;&quot;&quot;</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">UNVERIFIED_ORIGIN</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="capiscio_mcp.server.VerifyResult.has_identity" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">has_identity</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Check if server disclosed any identity.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="capiscio_mcp.server.VerifyResult.is_verified" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_verified</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Check if server identity is cryptographically verified.</p>

    </div>

</div>






  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="capiscio_mcp.server.verify_server" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">verify_server</span><span class="p">(</span><span class="n">server_did</span><span class="p">,</span> <span class="n">server_badge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transport_origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endpoint_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Verify MCP server identity per RFC-007 7.2.</p>
<p>This function implements the client verification algorithm:
1. If no DID disclosed  UNVERIFIED_ORIGIN
2. If DID but no badge  DECLARED_PRINCIPAL
3. If DID + badge  verify badge  VERIFIED_PRINCIPAL or error</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>server_did</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server DID from Capiscio-Server-DID header or _meta</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>server_badge</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server badge JWS from Capiscio-Server-Badge header or _meta</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>transport_origin</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HTTP origin (e.g., "https://mcp.example.com")</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>endpoint_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>URL path for did:web binding (e.g., "/mcp/filesystem")</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="VerifyConfig


  
      dataclass
   (capiscio_mcp.server.VerifyConfig)" href="#capiscio_mcp.server.VerifyConfig">VerifyConfig</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Verification configuration</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="VerifyResult


  
      dataclass
   (capiscio_mcp.server.VerifyResult)" href="#capiscio_mcp.server.VerifyResult">VerifyResult</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>VerifyResult with state, trust_level, and any error details</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>result = await verify_server(
    server_did="did:web:mcp.example.com:servers:filesystem",
    server_badge="eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9...",
    transport_origin="https://mcp.example.com",
)</p>
<p>match result.state:
    case ServerState.VERIFIED_PRINCIPAL:
        print(f"Verified at level {result.trust_level}")
    case ServerState.DECLARED_PRINCIPAL:
        print("Identity claimed but not verified")
    case ServerState.UNVERIFIED_ORIGIN:
        print("No identity disclosed")</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">verify_server</span><span class="p">(</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="n">server_did</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="n">server_badge</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="n">transport_origin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="n">endpoint_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VerifyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VerifyResult</span><span class="p">:</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">    Verify MCP server identity per RFC-007 7.2.</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">    This function implements the client verification algorithm:</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">    1. If no DID disclosed  UNVERIFIED_ORIGIN</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">    2. If DID but no badge  DECLARED_PRINCIPAL</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">    3. If DID + badge  verify badge  VERIFIED_PRINCIPAL or error</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">        server_did: Server DID from Capiscio-Server-DID header or _meta</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">        server_badge: Server badge JWS from Capiscio-Server-Badge header or _meta</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">        transport_origin: HTTP origin (e.g., &quot;https://mcp.example.com&quot;)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">        endpoint_path: URL path for did:web binding (e.g., &quot;/mcp/filesystem&quot;)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="sd">        config: Verification configuration</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">        VerifyResult with state, trust_level, and any error details</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">        result = await verify_server(</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">            server_did=&quot;did:web:mcp.example.com:servers:filesystem&quot;,</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">            server_badge=&quot;eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9...&quot;,</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">            transport_origin=&quot;https://mcp.example.com&quot;,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">        )</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">        match result.state:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">            case ServerState.VERIFIED_PRINCIPAL:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">                print(f&quot;Verified at level {result.trust_level}&quot;)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">            case ServerState.DECLARED_PRINCIPAL:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">                print(&quot;Identity claimed but not verified&quot;)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">            case ServerState.UNVERIFIED_ORIGIN:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">                print(&quot;No identity disclosed&quot;)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">capiscio_mcp._core.client</span><span class="w"> </span><span class="kn">import</span> <span class="n">CoreClient</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="n">effective_config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">VerifyConfig</span><span class="p">()</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="c1"># Quick path: no DID disclosed at all</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">server_did</span><span class="p">:</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Server did not disclose identity (UNVERIFIED_ORIGIN)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="k">return</span> <span class="n">VerifyResult</span><span class="p">(</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="n">state</span><span class="o">=</span><span class="n">ServerState</span><span class="o">.</span><span class="n">UNVERIFIED_ORIGIN</span><span class="p">,</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="n">error_code</span><span class="o">=</span><span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="c1"># Get core client</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">CoreClient</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="c1"># Import proto</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">capiscio_mcp._proto.capiscio.v1</span><span class="w"> </span><span class="kn">import</span> <span class="n">mcp_pb2</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="c1"># Build request</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="n">request</span> <span class="o">=</span> <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">VerifyServerIdentityRequest</span><span class="p">(</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="n">server_did</span><span class="o">=</span><span class="n">server_did</span><span class="p">,</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="n">server_badge</span><span class="o">=</span><span class="n">server_badge</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="n">transport_origin</span><span class="o">=</span><span class="n">transport_origin</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="n">endpoint_path</span><span class="o">=</span><span class="n">endpoint_path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="n">config</span><span class="o">=</span><span class="n">mcp_pb2</span><span class="o">.</span><span class="n">VerifyConfig</span><span class="p">(</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="n">trusted_issuers</span><span class="o">=</span><span class="n">effective_config</span><span class="o">.</span><span class="n">trusted_issuers</span> <span class="ow">or</span> <span class="p">[],</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>            <span class="n">min_trust_level</span><span class="o">=</span><span class="n">effective_config</span><span class="o">.</span><span class="n">min_trust_level</span><span class="p">,</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>            <span class="n">accept_level_zero</span><span class="o">=</span><span class="n">effective_config</span><span class="o">.</span><span class="n">accept_level_zero</span><span class="p">,</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>            <span class="n">offline_mode</span><span class="o">=</span><span class="n">effective_config</span><span class="o">.</span><span class="n">offline_mode</span><span class="p">,</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>            <span class="n">skip_origin_binding</span><span class="o">=</span><span class="n">effective_config</span><span class="o">.</span><span class="n">skip_origin_binding</span><span class="p">,</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="p">),</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>    <span class="p">)</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>    <span class="c1"># Make RPC call</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">stub</span><span class="o">.</span><span class="n">VerifyServerIdentity</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>    <span class="c1"># Map response state</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>    <span class="n">state_map</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">VERIFIED_PRINCIPAL</span><span class="p">:</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">VERIFIED_PRINCIPAL</span><span class="p">,</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">DECLARED_PRINCIPAL</span><span class="p">:</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">DECLARED_PRINCIPAL</span><span class="p">,</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">UNVERIFIED_ORIGIN</span><span class="p">:</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">UNVERIFIED_ORIGIN</span><span class="p">,</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="p">}</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="n">state</span> <span class="o">=</span> <span class="n">state_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">UNVERIFIED_ORIGIN</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="c1"># Map error code</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="n">error_code_map</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">SERVER_ERROR_NONE</span><span class="p">:</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">SERVER_DID_INVALID</span><span class="p">:</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">DID_INVALID</span><span class="p">,</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">SERVER_BADGE_INVALID</span><span class="p">:</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">BADGE_INVALID</span><span class="p">,</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">SERVER_BADGE_EXPIRED</span><span class="p">:</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">BADGE_EXPIRED</span><span class="p">,</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">SERVER_BADGE_REVOKED</span><span class="p">:</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">BADGE_REVOKED</span><span class="p">,</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">SERVER_TRUST_INSUFFICIENT</span><span class="p">:</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">TRUST_INSUFFICIENT</span><span class="p">,</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">SERVER_ORIGIN_MISMATCH</span><span class="p">:</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">ORIGIN_MISMATCH</span><span class="p">,</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">SERVER_PATH_MISMATCH</span><span class="p">:</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">PATH_MISMATCH</span><span class="p">,</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="n">mcp_pb2</span><span class="o">.</span><span class="n">SERVER_ISSUER_UNTRUSTED</span><span class="p">:</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">ISSUER_UNTRUSTED</span><span class="p">,</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="p">}</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="n">error_code</span> <span class="o">=</span> <span class="n">error_code_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">error_code</span><span class="p">,</span> <span class="n">ServerErrorCode</span><span class="o">.</span><span class="n">NONE</span><span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">VerifyResult</span><span class="p">(</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="n">trust_level</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">trust_level</span> <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">trust_level</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="n">server_did</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">server_did</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="n">badge_jti</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">badge_jti</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="n">error_code</span><span class="o">=</span><span class="n">error_code</span><span class="p">,</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="n">error_detail</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">error_detail</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server verification result: state=</span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">, trust_level=</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">trust_level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="capiscio_mcp.server.verify_server_sync" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">verify_server_sync</span><span class="p">(</span><span class="n">server_did</span><span class="p">,</span> <span class="n">server_badge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transport_origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endpoint_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Sync wrapper for verify_server.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>server_did</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server DID from Capiscio-Server-DID header or _meta</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>server_badge</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server badge JWS from Capiscio-Server-Badge header or _meta</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>transport_origin</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HTTP origin (e.g., "https://mcp.example.com")</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>endpoint_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>URL path for did:web binding</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="VerifyConfig


  
      dataclass
   (capiscio_mcp.server.VerifyConfig)" href="#capiscio_mcp.server.VerifyConfig">VerifyConfig</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Verification configuration</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="VerifyResult


  
      dataclass
   (capiscio_mcp.server.VerifyResult)" href="#capiscio_mcp.server.VerifyResult">VerifyResult</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>VerifyResult with state, trust_level, and any error details</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="k">def</span><span class="w"> </span><span class="nf">verify_server_sync</span><span class="p">(</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="n">server_did</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="n">server_badge</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>    <span class="n">transport_origin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>    <span class="n">endpoint_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VerifyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VerifyResult</span><span class="p">:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="sd">    Sync wrapper for verify_server.</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">        server_did: Server DID from Capiscio-Server-DID header or _meta</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="sd">        server_badge: Server badge JWS from Capiscio-Server-Badge header or _meta</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="sd">        transport_origin: HTTP origin (e.g., &quot;https://mcp.example.com&quot;)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="sd">        endpoint_path: URL path for did:web binding</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">        config: Verification configuration</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="sd">        VerifyResult with state, trust_level, and any error details</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="n">loop</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">concurrent.futures</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="n">verify_server</span><span class="p">(</span><span class="n">server_did</span><span class="p">,</span> <span class="n">server_badge</span><span class="p">,</span> <span class="n">transport_origin</span><span class="p">,</span> <span class="n">endpoint_path</span><span class="p">,</span> <span class="n">config</span><span class="p">),</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>            <span class="n">loop</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="p">)</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="k">return</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">)</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="k">return</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>            <span class="n">verify_server</span><span class="p">(</span><span class="n">server_did</span><span class="p">,</span> <span class="n">server_badge</span><span class="p">,</span> <span class="n">transport_origin</span><span class="p">,</span> <span class="n">endpoint_path</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="capiscio_mcp.server.parse_http_headers" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">parse_http_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Extract server identity from HTTP response headers.</p>
<p>RFC-007 6.1 specifies these header names:
- Capiscio-Server-DID: Server's DID
- Capiscio-Server-Badge: Server's badge (JWS)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>headers</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HTTP response headers dict (case-insensitive lookup)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="typing.Optional">Optional</span>[<span title="str">str</span>], <span title="typing.Optional">Optional</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of (server_did, server_badge)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>did, badge = parse_http_headers(response.headers)
result = await verify_server(did, badge)</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="k">def</span><span class="w"> </span><span class="nf">parse_http_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="sd">    Extract server identity from HTTP response headers.</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="sd">    RFC-007 6.1 specifies these header names:</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">    - Capiscio-Server-DID: Server&#39;s DID</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">    - Capiscio-Server-Badge: Server&#39;s badge (JWS)</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">        headers: HTTP response headers dict (case-insensitive lookup)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">        Tuple of (server_did, server_badge)</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">        did, badge = parse_http_headers(response.headers)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">        result = await verify_server(did, badge)</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>    <span class="c1"># Try exact case first, then case-insensitive</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_header</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>            <span class="k">return</span> <span class="n">headers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="c1"># Case-insensitive lookup</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>        <span class="n">lower_name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">lower_name</span><span class="p">:</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                <span class="k">return</span> <span class="n">value</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>        <span class="n">get_header</span><span class="p">(</span><span class="s2">&quot;Capiscio-Server-DID&quot;</span><span class="p">),</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="n">get_header</span><span class="p">(</span><span class="s2">&quot;Capiscio-Server-Badge&quot;</span><span class="p">),</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="capiscio_mcp.server.parse_jsonrpc_meta" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">parse_jsonrpc_meta</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Extract server identity from MCP initialize response _meta.</p>
<p>RFC-007 6.2 specifies these _meta keys:
- capiscio_server_did: Server's DID
- capiscio_server_badge: Server's badge (JWS)</p>
<p>For PoP fields, use pop.PoPRequest.from_meta() and pop.PoPResponse.from_meta().</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>meta</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The _meta object from InitializeResult</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="typing.Optional">Optional</span>[<span title="str">str</span>], <span title="typing.Optional">Optional</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of (server_did, server_badge)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <h3 id="capiscio_mcp.server.parse_jsonrpc_meta--in-mcp-client-initialization">In MCP client initialization</h3>
<p>result = await client.initialize()
did, badge = parse_jsonrpc_meta(result.meta)
verify_result = await verify_server(did, badge)</p>
<h3 id="capiscio_mcp.server.parse_jsonrpc_meta--for-pop-verification">For PoP verification</h3>
<p>from capiscio_mcp.pop import PoPResponse, verify_pop_response
pop_response = PoPResponse.from_meta(result.meta)</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="k">def</span><span class="w"> </span><span class="nf">parse_jsonrpc_meta</span><span class="p">(</span><span class="n">meta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a><span class="sd">    Extract server identity from MCP initialize response _meta.</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">    RFC-007 6.2 specifies these _meta keys:</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">    - capiscio_server_did: Server&#39;s DID</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">    - capiscio_server_badge: Server&#39;s badge (JWS)</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="sd">    For PoP fields, use pop.PoPRequest.from_meta() and pop.PoPResponse.from_meta().</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="sd">        meta: The _meta object from InitializeResult</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a><span class="sd">        Tuple of (server_did, server_badge)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="sd">        # In MCP client initialization</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="sd">        result = await client.initialize()</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">        did, badge = parse_jsonrpc_meta(result.meta)</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a><span class="sd">        verify_result = await verify_server(did, badge)</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a><span class="sd">        # For PoP verification</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="sd">        from capiscio_mcp.pop import PoPResponse, verify_pop_response</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="sd">        pop_response = PoPResponse.from_meta(result.meta)</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>    <span class="k">if</span> <span class="n">meta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>    <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capiscio_server_did&quot;</span><span class="p">),</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capiscio_server_badge&quot;</span><span class="p">),</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="pop-module-key-verification">PoP Module (Key Verification)</h2>


<div class="doc doc-object doc-module">



<a id="capiscio_mcp.pop"></a>
    <div class="doc doc-contents first">

        <p>Proof of Possession (PoP) primitives for RFC-007 MCP server identity.</p>
<p>This module implements the PoP handshake for MCP server identity verification:
1. Client generates a nonce and includes it in initialize request _meta
2. Server signs the nonce with its DID key and returns signature in response _meta
3. Client verifies the signature to prove server controls the DID key</p>
<p>The PoP handshake upgrades server state from DECLARED_PRINCIPAL to VERIFIED_PRINCIPAL.</p>
<p>Usage (Client):
    # Generate PoP request
    pop_request = generate_pop_request()</p>
<div class="highlight"><pre><span></span><code># Include in initialize request _meta
meta = {
    **pop_request.to_meta(),
    &quot;capiscio_server_did&quot;: server_did,  # If available
}

# After receiving response, verify PoP
pop_response = PoPResponse.from_meta(response._meta)
if pop_response:
    verify_pop_response(pop_request, pop_response, server_public_key)
</code></pre></div>
<p>Usage (Server):
    # Parse PoP request from client
    pop_request = PoPRequest.from_meta(request._meta)</p>
<div class="highlight"><pre><span></span><code># Create signed response
if pop_request and private_key:
    pop_response = create_pop_response(pop_request, private_key, key_id)

    # Include in initialize response _meta
    meta = {
        **identity_meta,
        **pop_response.to_meta(),
    }
</code></pre></div>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.pop.PoPRequest" class="doc doc-heading">
            <code>PoPRequest</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>PoP request sent by client in initialize request _meta.</p>
<p>Per RFC-007, the client generates a random nonce and includes it
in the initialize request. The server must sign this nonce to
prove possession of the DID key.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.pop.PoPRequest.client_nonce">client_nonce</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base64url-encoded random nonce (32 bytes)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.pop.PoPRequest.created_at">created_at</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timestamp when nonce was generated</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/pop.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="k">class</span><span class="w"> </span><span class="nc">PoPRequest</span><span class="p">:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">    PoP request sent by client in initialize request _meta.</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">    Per RFC-007, the client generates a random nonce and includes it</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">    in the initialize request. The server must sign this nonce to</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">    prove possession of the DID key.</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">        client_nonce: Base64url-encoded random nonce (32 bytes)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">        created_at: Timestamp when nonce was generated</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="n">client_nonce</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="n">created_at</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Unix timestamp</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">        Convert to _meta format for MCP initialize request.</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">            Dict with capiscio_pop_nonce and capiscio_pop_created_at</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="s2">&quot;capiscio_pop_nonce&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_nonce</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>            <span class="s2">&quot;capiscio_pop_created_at&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="p">),</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="p">}</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_meta</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">meta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;PoPRequest&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">        Parse PoP request from MCP _meta object.</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">            meta: The _meta dict from initialize request</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">            PoPRequest if present, None otherwise</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">meta</span><span class="p">:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="n">nonce</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capiscio_pop_nonce&quot;</span><span class="p">)</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">nonce</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nonce</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="c1"># Parse created_at with fallback to current time</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="n">created_at</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capiscio_pop_created_at&quot;</span><span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">created_at</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>            <span class="n">ts</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">created_at</span><span class="p">)</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">client_nonce</span><span class="o">=</span><span class="n">nonce</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">ts</span><span class="p">)</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_age</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">POP_MAX_AGE_SECONDS</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the PoP request has expired.&quot;&quot;&quot;</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_age</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">created_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get created_at as datetime.&quot;&quot;&quot;</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="capiscio_mcp.pop.PoPRequest.created_datetime" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">created_datetime</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Get created_at as datetime.</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.pop.PoPRequest.from_meta" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_meta</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Parse PoP request from MCP _meta object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>meta</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The _meta dict from initialize request</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[&#39;PoPRequest&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PoPRequest if present, None otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/pop.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="nd">@classmethod</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="k">def</span><span class="w"> </span><span class="nf">from_meta</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">meta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;PoPRequest&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">    Parse PoP request from MCP _meta object.</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">        meta: The _meta dict from initialize request</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">        PoPRequest if present, None otherwise</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">meta</span><span class="p">:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="n">nonce</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capiscio_pop_nonce&quot;</span><span class="p">)</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">nonce</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nonce</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>    <span class="c1"># Parse created_at with fallback to current time</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="n">created_at</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capiscio_pop_created_at&quot;</span><span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">created_at</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="n">ts</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">created_at</span><span class="p">)</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">client_nonce</span><span class="o">=</span><span class="n">nonce</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">ts</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.pop.PoPRequest.is_expired" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_expired</span><span class="p">(</span><span class="n">max_age</span><span class="o">=</span><span class="n">POP_MAX_AGE_SECONDS</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Check if the PoP request has expired.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/pop.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="k">def</span><span class="w"> </span><span class="nf">is_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_age</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">POP_MAX_AGE_SECONDS</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the PoP request has expired.&quot;&quot;&quot;</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_age</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.pop.PoPRequest.to_meta" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_meta</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Convert to _meta format for MCP initialize request.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict with capiscio_pop_nonce and capiscio_pop_created_at</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/pop.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="k">def</span><span class="w"> </span><span class="nf">to_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">    Convert to _meta format for MCP initialize request.</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">        Dict with capiscio_pop_nonce and capiscio_pop_created_at</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="s2">&quot;capiscio_pop_nonce&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_nonce</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="s2">&quot;capiscio_pop_created_at&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="p">),</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.pop.PoPResponse" class="doc doc-heading">
            <code>PoPResponse</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>PoP response sent by server in initialize response _meta.</p>
<p>Per RFC-007, the server signs the client's nonce with its DID key
and returns the signature. The client verifies this signature to
prove the server controls the private key for the disclosed DID.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.pop.PoPResponse.nonce_signature">nonce_signature</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>JWS compact serialization of signed nonce</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.pop.PoPResponse.signed_at">signed_at</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timestamp when signature was created</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/pop.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="k">class</span><span class="w"> </span><span class="nc">PoPResponse</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">    PoP response sent by server in initialize response _meta.</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">    Per RFC-007, the server signs the client&#39;s nonce with its DID key</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="sd">    and returns the signature. The client verifies this signature to</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">    prove the server controls the private key for the disclosed DID.</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="sd">        nonce_signature: JWS compact serialization of signed nonce</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="sd">        signed_at: Timestamp when signature was created</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>    <span class="n">nonce_signature</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="n">signed_at</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Unix timestamp</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="sd">        Convert to _meta format for MCP initialize response.</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a><span class="sd">            Dict with capiscio_pop_signature and capiscio_pop_signed_at</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="s2">&quot;capiscio_pop_signature&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonce_signature</span><span class="p">,</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="s2">&quot;capiscio_pop_signed_at&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signed_at</span><span class="p">),</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="p">}</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_meta</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">meta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;PoPResponse&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">        Parse PoP response from MCP _meta object.</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">            meta: The _meta dict from initialize response</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="sd">            PoPResponse if present, None otherwise</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">meta</span><span class="p">:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>        <span class="n">signature</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capiscio_pop_signature&quot;</span><span class="p">)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">signature</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="c1"># Parse signed_at with fallback to current time</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="n">signed_at</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capiscio_pop_signed_at&quot;</span><span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">signed_at</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="n">ts</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">signed_at</span><span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">nonce_signature</span><span class="o">=</span><span class="n">signature</span><span class="p">,</span> <span class="n">signed_at</span><span class="o">=</span><span class="n">ts</span><span class="p">)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">signed_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get signed_at as datetime.&quot;&quot;&quot;</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signed_at</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="capiscio_mcp.pop.PoPResponse.signed_datetime" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">signed_datetime</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Get signed_at as datetime.</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.pop.PoPResponse.from_meta" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_meta</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Parse PoP response from MCP _meta object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>meta</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The _meta dict from initialize response</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[&#39;PoPResponse&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PoPResponse if present, None otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/pop.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="nd">@classmethod</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="k">def</span><span class="w"> </span><span class="nf">from_meta</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">meta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;PoPResponse&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">    Parse PoP response from MCP _meta object.</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">        meta: The _meta dict from initialize response</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="sd">        PoPResponse if present, None otherwise</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">meta</span><span class="p">:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>    <span class="n">signature</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capiscio_pop_signature&quot;</span><span class="p">)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">signature</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>    <span class="c1"># Parse signed_at with fallback to current time</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="n">signed_at</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capiscio_pop_signed_at&quot;</span><span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">signed_at</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="n">ts</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">signed_at</span><span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">nonce_signature</span><span class="o">=</span><span class="n">signature</span><span class="p">,</span> <span class="n">signed_at</span><span class="o">=</span><span class="n">ts</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.pop.PoPResponse.to_meta" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_meta</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Convert to _meta format for MCP initialize response.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict with capiscio_pop_signature and capiscio_pop_signed_at</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/pop.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-194" name="__codelineno-0-194"></a><span class="k">def</span><span class="w"> </span><span class="nf">to_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="sd">    Convert to _meta format for MCP initialize response.</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a><span class="sd">        Dict with capiscio_pop_signature and capiscio_pop_signed_at</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="s2">&quot;capiscio_pop_signature&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonce_signature</span><span class="p">,</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="s2">&quot;capiscio_pop_signed_at&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signed_at</span><span class="p">),</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.pop.PoPError" class="doc doc-heading">
            <code>PoPError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="Exception">Exception</span></code></p>



        <p>Base exception for PoP errors.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/pop.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="k">class</span><span class="w"> </span><span class="nc">PoPError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base exception for PoP errors.&quot;&quot;&quot;</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.pop.PoPSignatureError" class="doc doc-heading">
            <code>PoPSignatureError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="PoPError (capiscio_mcp.pop.PoPError)" href="#capiscio_mcp.pop.PoPError">PoPError</a></code></p>



        <p>Error signing or verifying PoP.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/pop.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="k">class</span><span class="w"> </span><span class="nc">PoPSignatureError</span><span class="p">(</span><span class="n">PoPError</span><span class="p">):</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Error signing or verifying PoP.&quot;&quot;&quot;</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.pop.PoPExpiredError" class="doc doc-heading">
            <code>PoPExpiredError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="PoPError (capiscio_mcp.pop.PoPError)" href="#capiscio_mcp.pop.PoPError">PoPError</a></code></p>



        <p>PoP request has expired.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/pop.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-94">94</a></span>
<span class="normal"><a href="#__codelineno-0-95">95</a></span>
<span class="normal"><a href="#__codelineno-0-96">96</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="k">class</span><span class="w"> </span><span class="nc">PoPExpiredError</span><span class="p">(</span><span class="n">PoPError</span><span class="p">):</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;PoP request has expired.&quot;&quot;&quot;</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="capiscio_mcp.pop.generate_pop_request" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_pop_request</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Generate a new PoP request for MCP initialize.</p>
<p>Creates a request with a fresh nonce and current timestamp.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="PoPRequest


  
      dataclass
   (capiscio_mcp.pop.PoPRequest)" href="#capiscio_mcp.pop.PoPRequest">PoPRequest</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PoPRequest ready to include in _meta</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="capiscio_mcp.pop.PoPNonceError">PoPNonceError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If nonce generation fails</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/pop.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_pop_request</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">PoPRequest</span><span class="p">:</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">    Generate a new PoP request for MCP initialize.</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="sd">    Creates a request with a fresh nonce and current timestamp.</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="sd">        PoPRequest ready to include in _meta</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="sd">        PoPNonceError: If nonce generation fails</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>    <span class="k">return</span> <span class="n">PoPRequest</span><span class="p">(</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="n">client_nonce</span><span class="o">=</span><span class="n">generate_nonce</span><span class="p">(),</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>        <span class="n">created_at</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="capiscio_mcp.pop.create_pop_response" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_pop_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">key_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Create a PoP response by signing the client's nonce.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>request</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="PoPRequest


  
      dataclass
   (capiscio_mcp.pop.PoPRequest)" href="#capiscio_mcp.pop.PoPRequest">PoPRequest</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The PoP request containing client nonce</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>private_key</code>
            </td>
            <td>
                  <code>&#39;Ed25519PrivateKey&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server's Ed25519 private key</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>key_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Key ID for JWS header (e.g., DID key reference)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="PoPResponse


  
      dataclass
   (capiscio_mcp.pop.PoPResponse)" href="#capiscio_mcp.pop.PoPResponse">PoPResponse</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PoPResponse ready to include in _meta</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="capiscio_mcp.pop.PoPMissingCrypto">PoPMissingCrypto</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If cryptography package not available</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="PoPSignatureError (capiscio_mcp.pop.PoPSignatureError)" href="#capiscio_mcp.pop.PoPSignatureError">PoPSignatureError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If signing fails</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/pop.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-378" name="__codelineno-0-378"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_pop_response</span><span class="p">(</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>    <span class="n">request</span><span class="p">:</span> <span class="n">PoPRequest</span><span class="p">,</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>    <span class="n">private_key</span><span class="p">:</span> <span class="s2">&quot;Ed25519PrivateKey&quot;</span><span class="p">,</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>    <span class="n">key_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PoPResponse</span><span class="p">:</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a><span class="sd">    Create a PoP response by signing the client&#39;s nonce.</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">        request: The PoP request containing client nonce</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a><span class="sd">        private_key: Server&#39;s Ed25519 private key</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a><span class="sd">        key_id: Key ID for JWS header (e.g., DID key reference)</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a><span class="sd">        PoPResponse ready to include in _meta</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a><span class="sd">        PoPMissingCrypto: If cryptography package not available</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="sd">        PoPSignatureError: If signing fails</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>    <span class="n">signature</span> <span class="o">=</span> <span class="n">sign_nonce</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">client_nonce</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">key_id</span><span class="p">)</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>    <span class="k">return</span> <span class="n">PoPResponse</span><span class="p">(</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>        <span class="n">nonce_signature</span><span class="o">=</span><span class="n">signature</span><span class="p">,</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>        <span class="n">signed_at</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="capiscio_mcp.pop.verify_pop_response" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">verify_pop_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">public_key</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="n">POP_MAX_AGE_SECONDS</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Verify a complete PoP response.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>request</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="PoPRequest


  
      dataclass
   (capiscio_mcp.pop.PoPRequest)" href="#capiscio_mcp.pop.PoPRequest">PoPRequest</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The original PoP request</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>response</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="PoPResponse


  
      dataclass
   (capiscio_mcp.pop.PoPResponse)" href="#capiscio_mcp.pop.PoPResponse">PoPResponse</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The PoP response from server</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>public_key</code>
            </td>
            <td>
                  <code>&#39;Ed25519PublicKey&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server's Ed25519 public key</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_age</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum age of request in seconds</p>
              </div>
            </td>
            <td>
                  <code><span title="capiscio_mcp.pop.POP_MAX_AGE_SECONDS">POP_MAX_AGE_SECONDS</span></code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="capiscio_mcp.pop.PoPMissingCrypto">PoPMissingCrypto</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If cryptography package not available</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="PoPExpiredError (capiscio_mcp.pop.PoPExpiredError)" href="#capiscio_mcp.pop.PoPExpiredError">PoPExpiredError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If request has expired</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="PoPSignatureError (capiscio_mcp.pop.PoPSignatureError)" href="#capiscio_mcp.pop.PoPSignatureError">PoPSignatureError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If signature verification fails</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/pop.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-459" name="__codelineno-0-459"></a><span class="k">def</span><span class="w"> </span><span class="nf">verify_pop_response</span><span class="p">(</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>    <span class="n">request</span><span class="p">:</span> <span class="n">PoPRequest</span><span class="p">,</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>    <span class="n">response</span><span class="p">:</span> <span class="n">PoPResponse</span><span class="p">,</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>    <span class="n">public_key</span><span class="p">:</span> <span class="s2">&quot;Ed25519PublicKey&quot;</span><span class="p">,</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>    <span class="n">max_age</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">POP_MAX_AGE_SECONDS</span><span class="p">,</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a><span class="sd">    Verify a complete PoP response.</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="sd">        request: The original PoP request</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a><span class="sd">        response: The PoP response from server</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a><span class="sd">        public_key: Server&#39;s Ed25519 public key</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a><span class="sd">        max_age: Maximum age of request in seconds</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a><span class="sd">        PoPMissingCrypto: If cryptography package not available</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a><span class="sd">        PoPExpiredError: If request has expired</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a><span class="sd">        PoPSignatureError: If signature verification fails</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>    <span class="c1"># Check expiry</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">is_expired</span><span class="p">(</span><span class="n">max_age</span><span class="p">):</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>        <span class="k">raise</span> <span class="n">PoPExpiredError</span><span class="p">(</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>            <span class="sa">f</span><span class="s2">&quot;PoP request expired (age: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">request</span><span class="o">.</span><span class="n">created_at</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s, &quot;</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>            <span class="sa">f</span><span class="s2">&quot;max: </span><span class="si">{</span><span class="n">max_age</span><span class="si">}</span><span class="s2">s)&quot;</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>        <span class="p">)</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>    <span class="c1"># Verify signature</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>    <span class="n">verify_pop_signature</span><span class="p">(</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>        <span class="n">jws</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">nonce_signature</span><span class="p">,</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>        <span class="n">expected_nonce</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">client_nonce</span><span class="p">,</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>        <span class="n">public_key</span><span class="o">=</span><span class="n">public_key</span><span class="p">,</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="types">Types</h2>


<div class="doc doc-object doc-module">



<a id="capiscio_mcp.types"></a>
    <div class="doc doc-contents first">

        <p>Type definitions for capiscio-mcp.</p>
<p>Defines enums and dataclasses used across the package for:
- RFC-006: Tool authority decisions and deny reasons
- RFC-007: Server identity states and error codes</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.types.Decision" class="doc doc-heading">
            <code>Decision</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="str">str</span></code>, <code><span title="enum.Enum">Enum</span></code></p>



        <p>Tool access decision result.</p>
<p>Per RFC-006 6.3, every tool invocation attempt results in one of:
- ALLOW: Tool execution is permitted
- DENY: Tool execution is blocked with a reason</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/types.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="k">class</span><span class="w"> </span><span class="nc">Decision</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    Tool access decision result.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    Per RFC-006 6.3, every tool invocation attempt results in one of:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    - ALLOW: Tool execution is permitted</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    - DENY: Tool execution is blocked with a reason</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">ALLOW</span> <span class="o">=</span> <span class="s2">&quot;allow&quot;</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">DENY</span> <span class="o">=</span> <span class="s2">&quot;deny&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.types.AuthLevel" class="doc doc-heading">
            <code>AuthLevel</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="str">str</span></code>, <code><span title="enum.Enum">Enum</span></code></p>



        <p>Caller authentication assurance level.</p>
<p>Per RFC-006 5, every evidence log records the authentication method:
- ANONYMOUS: No identity material provided
- API_KEY: API key authentication (reduced assurance)
- BADGE: CapiscIO Trust Badge authentication (full assurance)</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/types.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="k">class</span><span class="w"> </span><span class="nc">AuthLevel</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    Caller authentication assurance level.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    Per RFC-006 5, every evidence log records the authentication method:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">    - ANONYMOUS: No identity material provided</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    - API_KEY: API key authentication (reduced assurance)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">    - BADGE: CapiscIO Trust Badge authentication (full assurance)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="n">ANONYMOUS</span> <span class="o">=</span> <span class="s2">&quot;anonymous&quot;</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">API_KEY</span> <span class="o">=</span> <span class="s2">&quot;api_key&quot;</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="n">BADGE</span> <span class="o">=</span> <span class="s2">&quot;badge&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.types.DenyReason" class="doc doc-heading">
            <code>DenyReason</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="str">str</span></code>, <code><span title="enum.Enum">Enum</span></code></p>



        <p>Reason for denying tool access.</p>
<p>Per RFC-006 6.4, denial must include a specific reason code.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/types.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="k">class</span><span class="w"> </span><span class="nc">DenyReason</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">    Reason for denying tool access.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">    Per RFC-006 6.4, denial must include a specific reason code.</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="c1"># Badge issues</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">BADGE_MISSING</span> <span class="o">=</span> <span class="s2">&quot;badge_missing&quot;</span>           <span class="c1"># Required but not provided</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="n">BADGE_INVALID</span> <span class="o">=</span> <span class="s2">&quot;badge_invalid&quot;</span>           <span class="c1"># Malformed or unverifiable</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="n">BADGE_EXPIRED</span> <span class="o">=</span> <span class="s2">&quot;badge_expired&quot;</span>           <span class="c1"># Past expiration time</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="n">BADGE_REVOKED</span> <span class="o">=</span> <span class="s2">&quot;badge_revoked&quot;</span>           <span class="c1"># On revocation list</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="c1"># Trust issues</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="n">TRUST_INSUFFICIENT</span> <span class="o">=</span> <span class="s2">&quot;trust_insufficient&quot;</span> <span class="c1"># Trust level &lt; min required</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="n">ISSUER_UNTRUSTED</span> <span class="o">=</span> <span class="s2">&quot;issuer_untrusted&quot;</span>     <span class="c1"># Issuer not in trusted list</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="c1"># Policy issues</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="n">TOOL_NOT_ALLOWED</span> <span class="o">=</span> <span class="s2">&quot;tool_not_allowed&quot;</span>     <span class="c1"># Tool not in allowed list</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="n">POLICY_DENIED</span> <span class="o">=</span> <span class="s2">&quot;policy_denied&quot;</span>           <span class="c1"># Policy evaluation failed</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="c1"># Other</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="n">INTERNAL_ERROR</span> <span class="o">=</span> <span class="s2">&quot;internal_error&quot;</span>         <span class="c1"># Unexpected error</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.types.ServerState" class="doc doc-heading">
            <code>ServerState</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="str">str</span></code>, <code><span title="enum.Enum">Enum</span></code></p>



        <p>Server identity verification state.</p>
<p>Per RFC-007 5.2, clients classify servers into three states:</p>
<ul>
<li>
<p>VERIFIED_PRINCIPAL: Server badge verified, trust level established.
  The server has disclosed a DID and a valid badge signed by a trusted issuer.</p>
</li>
<li>
<p>DECLARED_PRINCIPAL: Server DID disclosed but badge missing or invalid.
  Identity is claimed but not cryptographically verified.</p>
</li>
<li>
<p>UNVERIFIED_ORIGIN: Server did not disclose any identity material.
  This is distinct from Trust Level 0 (self-signed) - UNVERIFIED_ORIGIN
  means NO identity was disclosed at all.</p>
</li>
</ul>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/types.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="k">class</span><span class="w"> </span><span class="nc">ServerState</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">    Server identity verification state.</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">    Per RFC-007 5.2, clients classify servers into three states:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">    - VERIFIED_PRINCIPAL: Server badge verified, trust level established.</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">      The server has disclosed a DID and a valid badge signed by a trusted issuer.</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">    - DECLARED_PRINCIPAL: Server DID disclosed but badge missing or invalid.</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">      Identity is claimed but not cryptographically verified.</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">    - UNVERIFIED_ORIGIN: Server did not disclose any identity material.</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">      This is distinct from Trust Level 0 (self-signed) - UNVERIFIED_ORIGIN</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">      means NO identity was disclosed at all.</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="n">VERIFIED_PRINCIPAL</span> <span class="o">=</span> <span class="s2">&quot;verified_principal&quot;</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="n">DECLARED_PRINCIPAL</span> <span class="o">=</span> <span class="s2">&quot;declared_principal&quot;</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="n">UNVERIFIED_ORIGIN</span> <span class="o">=</span> <span class="s2">&quot;unverified_origin&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.types.ServerErrorCode" class="doc doc-heading">
            <code>ServerErrorCode</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="str">str</span></code>, <code><span title="enum.Enum">Enum</span></code></p>



        <p>Server identity verification error codes.</p>
<p>Per RFC-007 8, verification failures include specific error codes.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/types.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="k">class</span><span class="w"> </span><span class="nc">ServerErrorCode</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">    Server identity verification error codes.</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">    Per RFC-007 8, verification failures include specific error codes.</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>    <span class="n">NONE</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="n">DID_INVALID</span> <span class="o">=</span> <span class="s2">&quot;did_invalid&quot;</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="n">BADGE_INVALID</span> <span class="o">=</span> <span class="s2">&quot;badge_invalid&quot;</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="n">BADGE_EXPIRED</span> <span class="o">=</span> <span class="s2">&quot;badge_expired&quot;</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="n">BADGE_REVOKED</span> <span class="o">=</span> <span class="s2">&quot;badge_revoked&quot;</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="n">TRUST_INSUFFICIENT</span> <span class="o">=</span> <span class="s2">&quot;trust_insufficient&quot;</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="n">ORIGIN_MISMATCH</span> <span class="o">=</span> <span class="s2">&quot;origin_mismatch&quot;</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="n">PATH_MISMATCH</span> <span class="o">=</span> <span class="s2">&quot;path_mismatch&quot;</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="n">ISSUER_UNTRUSTED</span> <span class="o">=</span> <span class="s2">&quot;issuer_untrusted&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.types.TrustLevel" class="doc doc-heading">
            <code>TrustLevel</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="enum.IntEnum">IntEnum</span></code></p>



        <p>Trust levels per RFC-002.</p>
<ul>
<li>LEVEL_0: Self-signed (did:key issuer)</li>
<li>LEVEL_1: Domain Validated (DV)</li>
<li>LEVEL_2: Organization Validated (OV)</li>
<li>LEVEL_3: Extended Validation (EV)</li>
<li>LEVEL_4: Continuous Validation (CV)</li>
</ul>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/types.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="k">class</span><span class="w"> </span><span class="nc">TrustLevel</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">    Trust levels per RFC-002.</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">    - LEVEL_0: Self-signed (did:key issuer)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">    - LEVEL_1: Domain Validated (DV)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">    - LEVEL_2: Organization Validated (OV)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">    - LEVEL_3: Extended Validation (EV)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">    - LEVEL_4: Continuous Validation (CV)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="n">LEVEL_0</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Self-signed</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="n">LEVEL_1</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># DV</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="n">LEVEL_2</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># OV</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="n">LEVEL_3</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># EV</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>    <span class="n">LEVEL_4</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># CV</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.types.CallerCredential" class="doc doc-heading">
            <code>CallerCredential</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Caller credential for tool access evaluation.</p>
<p>Only one of badge_jws or api_key should be set.
If neither is set, the caller is treated as anonymous.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/types.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="k">class</span><span class="w"> </span><span class="nc">CallerCredential</span><span class="p">:</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">    Caller credential for tool access evaluation.</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">    Only one of badge_jws or api_key should be set.</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">    If neither is set, the caller is treated as anonymous.</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="n">badge_jws</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">auth_level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AuthLevel</span><span class="p">:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Derive authentication level from credential type.&quot;&quot;&quot;</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">badge_jws</span><span class="p">:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="k">return</span> <span class="n">AuthLevel</span><span class="o">.</span><span class="n">BADGE</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">:</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="k">return</span> <span class="n">AuthLevel</span><span class="o">.</span><span class="n">API_KEY</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="k">return</span> <span class="n">AuthLevel</span><span class="o">.</span><span class="n">ANONYMOUS</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="capiscio_mcp.types.CallerCredential.auth_level" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">auth_level</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Derive authentication level from credential type.</p>

    </div>

</div>






  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="errors">Errors</h2>


<div class="doc doc-object doc-module">



<a id="capiscio_mcp.errors"></a>
    <div class="doc doc-contents first">

        <p>Exception types for capiscio-mcp.</p>
<p>Provides typed exceptions for:
- Guard (RFC-006) errors
- Server verification (RFC-007) errors
- Core connection errors</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.errors.GuardError" class="doc doc-heading">
            <code>GuardError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="capiscio_mcp.errors.CapiscioMCPError">CapiscioMCPError</span></code></p>



        <p>Raised when tool access is denied by the guard.</p>
<p>Per RFC-006, all denials include:
- reason: Specific denial reason code
- detail: Human-readable explanation
- evidence_id: ID of the evidence record for audit</p>


<details class="example" open>
  <summary>Example</summary>
  <p>try:
    result = await guarded_tool(params)
except GuardError as e:
    logger.warning(f"Access denied: {e.reason} - {e.detail}")
    logger.info(f"Evidence ID: {e.evidence_id}")</p>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span>
<span class="normal"><a href="#__codelineno-0-92">92</a></span>
<span class="normal"><a href="#__codelineno-0-93">93</a></span>
<span class="normal"><a href="#__codelineno-0-94">94</a></span>
<span class="normal"><a href="#__codelineno-0-95">95</a></span>
<span class="normal"><a href="#__codelineno-0-96">96</a></span>
<span class="normal"><a href="#__codelineno-0-97">97</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="k">class</span><span class="w"> </span><span class="nc">GuardError</span><span class="p">(</span><span class="n">CapiscioMCPError</span><span class="p">):</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">    Raised when tool access is denied by the guard.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    Per RFC-006, all denials include:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">    - reason: Specific denial reason code</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">    - detail: Human-readable explanation</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">    - evidence_id: ID of the evidence record for audit</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">        try:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">            result = await guarded_tool(params)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">        except GuardError as e:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">            logger.warning(f&quot;Access denied: {e.reason} - {e.detail}&quot;)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">            logger.info(f&quot;Evidence ID: {e.evidence_id}&quot;)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="n">reason</span><span class="p">:</span> <span class="s2">&quot;DenyReason&quot;</span><span class="p">,</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="n">detail</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="n">evidence_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="n">agent_did</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="n">trust_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="p">):</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">detail</span> <span class="o">=</span> <span class="n">detail</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">evidence_id</span> <span class="o">=</span> <span class="n">evidence_id</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent_did</span> <span class="o">=</span> <span class="n">agent_did</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trust_level</span> <span class="o">=</span> <span class="n">trust_level</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reason</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">detail</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="k">if</span> <span class="n">evidence_id</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (evidence_id=</span><span class="si">{</span><span class="n">evidence_id</span><span class="si">}</span><span class="s2">)&quot;</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="sa">f</span><span class="s2">&quot;GuardError(reason=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="si">!r}</span><span class="s2">, detail=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">detail</span><span class="si">!r}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="sa">f</span><span class="s2">&quot;evidence_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">evidence_id</span><span class="si">!r}</span><span class="s2">)&quot;</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.errors.GuardConfigError" class="doc doc-heading">
            <code>GuardConfigError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="capiscio_mcp.errors.CapiscioMCPError">CapiscioMCPError</span></code></p>



        <p>Raised when guard configuration is invalid.</p>
<p>This includes:
- Invalid trust level values
- Invalid tool name patterns
- Conflicting configuration options</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="k">class</span><span class="w"> </span><span class="nc">GuardConfigError</span><span class="p">(</span><span class="n">CapiscioMCPError</span><span class="p">):</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">    Raised when guard configuration is invalid.</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">    This includes:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">    - Invalid trust level values</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">    - Invalid tool name patterns</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">    - Conflicting configuration options</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.errors.ServerVerifyError" class="doc doc-heading">
            <code>ServerVerifyError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="capiscio_mcp.errors.CapiscioMCPError">CapiscioMCPError</span></code></p>



        <p>Raised when server identity verification fails.</p>
<p>Per RFC-007, verification can fail for various reasons including:
- Invalid DID format
- Badge verification failure
- Origin/path binding mismatch
- Trust level insufficient</p>


<details class="example" open>
  <summary>Example</summary>
  <p>try:
    result = await verify_server(server_did, server_badge)
except ServerVerifyError as e:
    logger.warning(f"Server verification failed: {e.error_code}")
    if e.state == ServerState.UNVERIFIED_ORIGIN:
        logger.warning("Server did not disclose identity")</p>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="k">class</span><span class="w"> </span><span class="nc">ServerVerifyError</span><span class="p">(</span><span class="n">CapiscioMCPError</span><span class="p">):</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">    Raised when server identity verification fails.</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">    Per RFC-007, verification can fail for various reasons including:</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">    - Invalid DID format</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">    - Badge verification failure</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">    - Origin/path binding mismatch</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">    - Trust level insufficient</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">        try:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">            result = await verify_server(server_did, server_badge)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">        except ServerVerifyError as e:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">            logger.warning(f&quot;Server verification failed: {e.error_code}&quot;)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">            if e.state == ServerState.UNVERIFIED_ORIGIN:</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">                logger.warning(&quot;Server did not disclose identity&quot;)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="n">error_code</span><span class="p">:</span> <span class="s2">&quot;ServerErrorCode&quot;</span><span class="p">,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="n">detail</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="n">state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ServerState&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="n">server_did</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="p">):</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">error_code</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">detail</span> <span class="o">=</span> <span class="n">detail</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">server_did</span> <span class="o">=</span> <span class="n">server_did</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_code</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">detail</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="sa">f</span><span class="s2">&quot;ServerVerifyError(error_code=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">error_code</span><span class="si">!r}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="sa">f</span><span class="s2">&quot;detail=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">detail</span><span class="si">!r}</span><span class="s2">, state=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="si">!r}</span><span class="s2">)&quot;</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.errors.CoreConnectionError" class="doc doc-heading">
            <code>CoreConnectionError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="capiscio_mcp.errors.CapiscioMCPError">CapiscioMCPError</span></code></p>



        <p>Raised when connection to capiscio-core fails.</p>
<p>This includes:
- Binary download failures
- Process startup failures
- gRPC connection failures
- Health check failures</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="k">class</span><span class="w"> </span><span class="nc">CoreConnectionError</span><span class="p">(</span><span class="n">CapiscioMCPError</span><span class="p">):</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">    Raised when connection to capiscio-core fails.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">    This includes:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    - Binary download failures</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">    - Process startup failures</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">    - gRPC connection failures</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    - Health check failures</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.errors.CoreVersionError" class="doc doc-heading">
            <code>CoreVersionError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="capiscio_mcp.errors.CapiscioMCPError">CapiscioMCPError</span></code></p>



        <p>Raised when capiscio-core version is incompatible.</p>
<p>capiscio-mcp requires a specific range of capiscio-core versions.
This error indicates the connected core is outside that range.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="k">class</span><span class="w"> </span><span class="nc">CoreVersionError</span><span class="p">(</span><span class="n">CapiscioMCPError</span><span class="p">):</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">    Raised when capiscio-core version is incompatible.</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">    capiscio-mcp requires a specific range of capiscio-core versions.</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">    This error indicates the connected core is outside that range.</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>

    </div>

</div>




  </div>

    </div>

</div><h2 id="mcp-sdk-integration">MCP SDK Integration</h2>


<div class="doc doc-object doc-module">



<a id="capiscio_mcp.integrations.mcp"></a>
    <div class="doc doc-contents first">

        <p>MCP SDK Integration  requires <code>pip install capiscio-mcp[mcp]</code></p>
<p>Provides two separate integration classes:
1. Server-side: CapiscioMCPServer (guard tools, disclose identity, PoP signing)
2. Client-side: CapiscioMCPClient (verify server identity, PoP verification)</p>
<p>Usage (Server):
    from capiscio_mcp.integrations.mcp import CapiscioMCPServer</p>
<div class="highlight"><pre><span></span><code>server = CapiscioMCPServer(
    name=&quot;filesystem&quot;,
    did=&quot;did:web:mcp.example.com:servers:filesystem&quot;,
    badge=&quot;eyJhbGc...&quot;,
    private_key_path=&quot;/path/to/key.pem&quot;,  # For PoP signing
)

@server.tool(min_trust_level=2)
async def read_file(path: str) -&gt; str:
    with open(path) as f:
        return f.read()
</code></pre></div>
<p>Usage (Client):
    from capiscio_mcp.integrations.mcp import CapiscioMCPClient</p>
<div class="highlight"><pre><span></span><code>async with CapiscioMCPClient(
    server_url=&quot;https://mcp.example.com&quot;,
    min_trust_level=2,
    require_pop=True,  # Require PoP verification
) as client:
    result = await client.call_tool(&quot;read_file&quot;, {&quot;path&quot;: &quot;/data/file.txt&quot;})
</code></pre></div>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.integrations.mcp.CapiscioMCPClient" class="doc doc-heading">
            <code>CapiscioMCPClient</code>


</h2>


    <div class="doc doc-contents ">



        <p>MCP Client with automatic server identity and PoP verification.</p>
<p>This class wraps MCP client functionality to:
1. Generate PoP request (nonce) for initialize request
2. Verify server identity and PoP response on connection
3. Enforce trust level requirements
4. Include caller credentials in tool requests</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.integrations.mcp.CapiscioMCPClient.server_url">server_url</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>URL of the MCP server</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.integrations.mcp.CapiscioMCPClient.min_trust_level">min_trust_level</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum required trust level</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.integrations.mcp.CapiscioMCPClient.fail_on_unverified">fail_on_unverified</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, raise on unverified servers</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.integrations.mcp.CapiscioMCPClient.require_pop">require_pop</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, require PoP verification (did:key servers)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="pop_verified

  
      property
   (capiscio_mcp.integrations.mcp.CapiscioMCPClient.pop_verified)" href="#capiscio_mcp.integrations.mcp.CapiscioMCPClient.pop_verified">pop_verified</a></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether PoP verification succeeded</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>async with CapiscioMCPClient(
    server_url="https://mcp.example.com",
    min_trust_level=2,
    require_pop=True,
    badge="eyJhbGc...",  # Your client badge
) as client:
    # Server identity and PoP already verified
    print(f"Trusted at level {client.server_trust_level}")
    print(f"PoP verified: {client.pop_verified}")</p>
<div class="highlight"><pre><span></span><code>result = await client.call_tool(&quot;read_file&quot;, {&quot;path&quot;: &quot;/data/file.txt&quot;})
</code></pre></div>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/integrations/mcp.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-367" name="__codelineno-0-367"></a><span class="k">class</span><span class="w"> </span><span class="nc">CapiscioMCPClient</span><span class="p">:</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a><span class="sd">    MCP Client with automatic server identity and PoP verification.</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a><span class="sd">    This class wraps MCP client functionality to:</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a><span class="sd">    1. Generate PoP request (nonce) for initialize request</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a><span class="sd">    2. Verify server identity and PoP response on connection</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a><span class="sd">    3. Enforce trust level requirements</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a><span class="sd">    4. Include caller credentials in tool requests</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a><span class="sd">        server_url: URL of the MCP server</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a><span class="sd">        min_trust_level: Minimum required trust level</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a><span class="sd">        fail_on_unverified: If True, raise on unverified servers</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a><span class="sd">        require_pop: If True, require PoP verification (did:key servers)</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="sd">        pop_verified: Whether PoP verification succeeded</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="sd">        async with CapiscioMCPClient(</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">            server_url=&quot;https://mcp.example.com&quot;,</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">            min_trust_level=2,</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a><span class="sd">            require_pop=True,</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a><span class="sd">            badge=&quot;eyJhbGc...&quot;,  # Your client badge</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a><span class="sd">        ) as client:</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a><span class="sd">            # Server identity and PoP already verified</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a><span class="sd">            print(f&quot;Trusted at level {client.server_trust_level}&quot;)</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a><span class="sd">            print(f&quot;PoP verified: {client.pop_verified}&quot;)</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a><span class="sd">            result = await client.call_tool(&quot;read_file&quot;, {&quot;path&quot;: &quot;/data/file.txt&quot;})</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>        <span class="n">server_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>        <span class="n">min_trust_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>        <span class="n">fail_on_unverified</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>        <span class="n">require_pop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>        <span class="n">verify_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VerifyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>        <span class="n">badge</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>        <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>    <span class="p">):</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a><span class="sd">        Initialize CapiscIO MCP Client.</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a><span class="sd">            server_url: URL of the MCP server</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a><span class="sd">            min_trust_level: Minimum required server trust level</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a><span class="sd">            fail_on_unverified: If True, raise when server doesn&#39;t disclose identity</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a><span class="sd">            require_pop: If True, require PoP verification for did:key servers</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a><span class="sd">            verify_config: Full verification configuration</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a><span class="sd">            badge: Client badge for authentication (recommended)</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a><span class="sd">            api_key: Client API key for authentication (alternative)</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>        <span class="n">_require_mcp_client</span><span class="p">()</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">server_url</span> <span class="o">=</span> <span class="n">server_url</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">=</span> <span class="n">min_trust_level</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fail_on_unverified</span> <span class="o">=</span> <span class="n">fail_on_unverified</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">require_pop</span> <span class="o">=</span> <span class="n">require_pop</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verify_config</span> <span class="o">=</span> <span class="n">verify_config</span> <span class="ow">or</span> <span class="n">VerifyConfig</span><span class="p">(</span><span class="n">min_trust_level</span><span class="o">=</span><span class="n">min_trust_level</span><span class="p">)</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>        <span class="c1"># Client credentials</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_credential</span> <span class="o">=</span> <span class="n">CallerCredential</span><span class="p">(</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>            <span class="n">badge_jws</span><span class="o">=</span><span class="n">badge</span><span class="p">,</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>        <span class="p">)</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">McpClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VerifyResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>        <span class="c1"># PoP state</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pop_request</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PoPRequest</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pop_response</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PoPResponse</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pop_verified</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_initialize_request_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a><span class="sd">        Create the _meta object for initialize request.</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="sd">        This should be called when building the initialize request.</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="sd">        It generates a PoP nonce to be signed by the server.</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a><span class="sd">            Dict to include as _meta in initialize request</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a><span class="sd">        Example:</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a><span class="sd">            # In your client code</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a><span class="sd">            meta = client.create_initialize_request_meta()</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a><span class="sd">            result = await session.initialize(</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a><span class="sd">                client_info=ClientInfo(...),</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a><span class="sd">                _meta=meta,</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a><span class="sd">            )</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pop_request</span> <span class="o">=</span> <span class="n">generate_pop_request</span><span class="p">()</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_request</span><span class="o">.</span><span class="n">to_meta</span><span class="p">()</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">verify_initialize_response</span><span class="p">(</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>        <span class="n">response_meta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>        <span class="n">server_public_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Ed25519PublicKey&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a><span class="sd">        Verify the initialize response including PoP.</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a><span class="sd">        This should be called after receiving the initialize response.</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a><span class="sd">        It extracts the PoP signature and verifies it.</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a><span class="sd">            response_meta: The _meta from initialize response</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a><span class="sd">            server_public_key: Server&#39;s public key for PoP verification</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a><span class="sd">                              (if None, will try to extract from did:key)</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a><span class="sd">            True if PoP verification succeeded, False otherwise</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a><span class="sd">            PoPSignatureError: If PoP verification fails and require_pop=True</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>        <span class="k">if</span> <span class="n">response_meta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No _meta in initialize response&quot;</span><span class="p">)</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>        <span class="c1"># Extract PoP response</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pop_response</span> <span class="o">=</span> <span class="n">PoPResponse</span><span class="o">.</span><span class="n">from_meta</span><span class="p">(</span><span class="n">response_meta</span><span class="p">)</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No PoP response in initialize response&quot;</span><span class="p">)</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;PoP response received but no request was sent&quot;</span><span class="p">)</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>        <span class="c1"># Get public key for verification</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>        <span class="k">if</span> <span class="n">server_public_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>            <span class="c1"># Try to extract from server DID</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>            <span class="n">server_did</span> <span class="o">=</span> <span class="n">response_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capiscio_server_did&quot;</span><span class="p">)</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>            <span class="k">if</span> <span class="n">server_did</span> <span class="ow">and</span> <span class="n">server_did</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;did:key:&quot;</span><span class="p">):</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>                    <span class="n">server_public_key</span> <span class="o">=</span> <span class="n">extract_public_key_from_did_key</span><span class="p">(</span><span class="n">server_did</span><span class="p">)</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to extract public key from DID: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_pop</span><span class="p">:</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>                        <span class="k">raise</span> <span class="n">PoPSignatureError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot extract public key from </span><span class="si">{</span><span class="n">server_did</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>                    <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>                <span class="c1"># For did:web, we&#39;d need to fetch DID document</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot verify PoP for non-did:key: </span><span class="si">{</span><span class="n">server_did</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>                <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>        <span class="c1"># Verify PoP</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>            <span class="n">verify_pop_response</span><span class="p">(</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>                <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pop_request</span><span class="p">,</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>                <span class="n">response</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pop_response</span><span class="p">,</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>                <span class="n">public_key</span><span class="o">=</span><span class="n">server_public_key</span><span class="p">,</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>            <span class="p">)</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_verified</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PoP verification succeeded&quot;</span><span class="p">)</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>        <span class="k">except</span> <span class="n">PoPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PoP verification failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_pop</span><span class="p">:</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>                <span class="k">raise</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pop_verified</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether PoP verification succeeded.&quot;&quot;&quot;</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_verified</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CapiscioMCPClient&quot;</span><span class="p">:</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a><span class="sd">        Async context manager entry.</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a><span class="sd">        Connects to server and verifies identity.</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Async context manager exit.&quot;&quot;&quot;</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a><span class="sd">        Connect to MCP server and verify identity.</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a><span class="sd">            ServerVerifyError: If server verification fails and fail_on_unverified=True</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a><span class="sd">            GuardError: If server doesn&#39;t meet trust requirements</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>        <span class="c1"># Connect to MCP server</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>        <span class="c1"># Implementation depends on MCP SDK transport</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>        <span class="c1"># Extract server identity from initialize response</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>        <span class="c1"># This is a placeholder - actual implementation depends on MCP SDK</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>        <span class="n">server_did</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>        <span class="n">server_badge</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>        <span class="c1"># If we get _meta from initialize response:</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>        <span class="c1"># server_did, server_badge = parse_jsonrpc_meta(init_result.meta)</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>        <span class="c1"># Verify server identity</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">verify_server</span><span class="p">(</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>            <span class="n">server_did</span><span class="o">=</span><span class="n">server_did</span><span class="p">,</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>            <span class="n">server_badge</span><span class="o">=</span><span class="n">server_badge</span><span class="p">,</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>            <span class="n">transport_origin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server_url</span><span class="p">,</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_config</span><span class="p">,</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>        <span class="p">)</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>        <span class="c1"># Enforce requirements</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_on_unverified</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">UNVERIFIED_ORIGIN</span><span class="p">:</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>            <span class="k">raise</span> <span class="n">ServerVerifyError</span><span class="p">(</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>                <span class="n">error_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">error_code</span><span class="p">,</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>                <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Server at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_url</span><span class="si">}</span><span class="s2"> did not disclose identity&quot;</span><span class="p">,</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>                <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>            <span class="p">)</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">DECLARED_PRINCIPAL</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>            <span class="k">raise</span> <span class="n">ServerVerifyError</span><span class="p">(</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>                <span class="n">error_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">error_code</span><span class="p">,</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>                <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Server at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_url</span><span class="si">}</span><span class="s2"> did not provide verifiable badge&quot;</span><span class="p">,</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>                <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>                <span class="n">server_did</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">server_did</span><span class="p">,</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>            <span class="p">)</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>        <span class="k">if</span> <span class="p">(</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">VERIFIED_PRINCIPAL</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">trust_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">trust_level</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>        <span class="p">):</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>            <span class="k">raise</span> <span class="n">ServerVerifyError</span><span class="p">(</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>                <span class="n">error_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">error_code</span><span class="p">,</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>                <span class="n">detail</span><span class="o">=</span><span class="p">(</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>                    <span class="sa">f</span><span class="s2">&quot;Server trust level </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">trust_level</span><span class="si">}</span><span class="s2"> &quot;</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>                    <span class="sa">f</span><span class="s2">&quot;is below required </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>                <span class="p">),</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>                <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>                <span class="n">server_did</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">server_did</span><span class="p">,</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>            <span class="p">)</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>            <span class="sa">f</span><span class="s2">&quot;Connected to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_url</span><span class="si">}</span><span class="s2">: &quot;</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>            <span class="sa">f</span><span class="s2">&quot;state=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>            <span class="sa">f</span><span class="s2">&quot;trust_level=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">trust_level</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>        <span class="p">)</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close connection to MCP server.&quot;&quot;&quot;</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">:</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>            <span class="c1"># Close session</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>            <span class="k">pass</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">server_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ServerState</span><span class="p">]:</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Server verification state after connection.&quot;&quot;&quot;</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">state</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">server_trust_level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Server trust level if verified.&quot;&quot;&quot;</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">trust_level</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">server_did</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Server DID if disclosed.&quot;&quot;&quot;</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">server_did</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_verified</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if server identity is cryptographically verified.&quot;&quot;&quot;</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">VERIFIED_PRINCIPAL</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>        <span class="p">)</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">call_tool</span><span class="p">(</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>        <span class="n">arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a><span class="sd">        Call a tool on the verified server.</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a><span class="sd">        Automatically includes client credentials in the request.</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a><span class="sd">            name: Tool name</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a><span class="sd">            arguments: Tool arguments</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a><span class="sd">            Tool result</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a><span class="sd">            RuntimeError: If not connected</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Client not connected. Use &#39;async with&#39; context.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>        <span class="c1"># Set credential context for the call</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>        <span class="n">token</span> <span class="o">=</span> <span class="n">set_credential</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_credential</span><span class="p">)</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>            <span class="c1"># Call tool via MCP client</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>            <span class="c1"># Implementation depends on MCP SDK</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>            <span class="k">pass</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>        <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>            <span class="c1"># Reset credential context</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>            <span class="k">pass</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a><span class="sd">        List available tools on the server.</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a><span class="sd">            List of tool definitions</span>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Client not connected. Use &#39;async with&#39; context.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>        <span class="c1"># List tools via MCP client</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>        <span class="c1"># Implementation depends on MCP SDK</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>        <span class="k">return</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPClient.is_verified" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_verified</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Check if server identity is cryptographically verified.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPClient.pop_verified" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pop_verified</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Whether PoP verification succeeded.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPClient.server_did" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">server_did</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Server DID if disclosed.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPClient.server_state" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">server_state</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Server verification state after connection.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPClient.server_trust_level" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">server_trust_level</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Server trust level if verified.</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPClient.__aenter__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__aenter__</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Async context manager entry.</p>
<p>Connects to server and verifies identity.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/integrations/mcp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-538" name="__codelineno-0-538"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CapiscioMCPClient&quot;</span><span class="p">:</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a><span class="sd">    Async context manager entry.</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a><span class="sd">    Connects to server and verifies identity.</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPClient.__aexit__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__aexit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Async context manager exit.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/integrations/mcp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-547" name="__codelineno-0-547"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Async context manager exit.&quot;&quot;&quot;</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPClient.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">server_url</span><span class="p">,</span> <span class="n">min_trust_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fail_on_unverified</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">require_pop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verify_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">badge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize CapiscIO MCP Client.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>server_url</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>URL of the MCP server</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_trust_level</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum required server trust level</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fail_on_unverified</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, raise when server doesn't disclose identity</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>require_pop</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, require PoP verification for did:key servers</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verify_config</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="VerifyConfig


  
      dataclass
   (capiscio_mcp.server.VerifyConfig)" href="#capiscio_mcp.server.VerifyConfig">VerifyConfig</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Full verification configuration</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>badge</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Client badge for authentication (recommended)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>api_key</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Client API key for authentication (alternative)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/integrations/mcp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-398" name="__codelineno-0-398"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>    <span class="n">server_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>    <span class="n">min_trust_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>    <span class="n">fail_on_unverified</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>    <span class="n">require_pop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>    <span class="n">verify_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VerifyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>    <span class="n">badge</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a><span class="p">):</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a><span class="sd">    Initialize CapiscIO MCP Client.</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a><span class="sd">        server_url: URL of the MCP server</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a><span class="sd">        min_trust_level: Minimum required server trust level</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a><span class="sd">        fail_on_unverified: If True, raise when server doesn&#39;t disclose identity</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a><span class="sd">        require_pop: If True, require PoP verification for did:key servers</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a><span class="sd">        verify_config: Full verification configuration</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a><span class="sd">        badge: Client badge for authentication (recommended)</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a><span class="sd">        api_key: Client API key for authentication (alternative)</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>    <span class="n">_require_mcp_client</span><span class="p">()</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">server_url</span> <span class="o">=</span> <span class="n">server_url</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">=</span> <span class="n">min_trust_level</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">fail_on_unverified</span> <span class="o">=</span> <span class="n">fail_on_unverified</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">require_pop</span> <span class="o">=</span> <span class="n">require_pop</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">verify_config</span> <span class="o">=</span> <span class="n">verify_config</span> <span class="ow">or</span> <span class="n">VerifyConfig</span><span class="p">(</span><span class="n">min_trust_level</span><span class="o">=</span><span class="n">min_trust_level</span><span class="p">)</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>    <span class="c1"># Client credentials</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_credential</span> <span class="o">=</span> <span class="n">CallerCredential</span><span class="p">(</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>        <span class="n">badge_jws</span><span class="o">=</span><span class="n">badge</span><span class="p">,</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>    <span class="p">)</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">McpClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VerifyResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>    <span class="c1"># PoP state</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_request</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PoPRequest</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_response</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PoPResponse</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_verified</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPClient.call_tool" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">call_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Call a tool on the verified server.</p>
<p>Automatically includes client credentials in the request.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tool name</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>arguments</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tool arguments</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tool result</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If not connected</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/integrations/mcp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-646" name="__codelineno-0-646"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">call_tool</span><span class="p">(</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>    <span class="n">arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a><span class="sd">    Call a tool on the verified server.</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a><span class="sd">    Automatically includes client credentials in the request.</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a><span class="sd">        name: Tool name</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a><span class="sd">        arguments: Tool arguments</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a><span class="sd">        Tool result</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a><span class="sd">        RuntimeError: If not connected</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Client not connected. Use &#39;async with&#39; context.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>    <span class="c1"># Set credential context for the call</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>    <span class="n">token</span> <span class="o">=</span> <span class="n">set_credential</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_credential</span><span class="p">)</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>        <span class="c1"># Call tool via MCP client</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>        <span class="c1"># Implementation depends on MCP SDK</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>        <span class="k">pass</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>    <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>        <span class="c1"># Reset credential context</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPClient.close" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">close</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Close connection to MCP server.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/integrations/mcp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-615" name="__codelineno-0-615"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Close connection to MCP server.&quot;&quot;&quot;</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">:</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>        <span class="c1"># Close session</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>        <span class="k">pass</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPClient.connect" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">connect</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Connect to MCP server and verify identity.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="ServerVerifyError (capiscio_mcp.errors.ServerVerifyError)" href="#capiscio_mcp.errors.ServerVerifyError">ServerVerifyError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If server verification fails and fail_on_unverified=True</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="GuardError (capiscio_mcp.errors.GuardError)" href="#capiscio_mcp.errors.GuardError">GuardError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If server doesn't meet trust requirements</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/integrations/mcp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-551" name="__codelineno-0-551"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a><span class="sd">    Connect to MCP server and verify identity.</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a><span class="sd">        ServerVerifyError: If server verification fails and fail_on_unverified=True</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a><span class="sd">        GuardError: If server doesn&#39;t meet trust requirements</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>    <span class="c1"># Connect to MCP server</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>    <span class="c1"># Implementation depends on MCP SDK transport</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>    <span class="c1"># Extract server identity from initialize response</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>    <span class="c1"># This is a placeholder - actual implementation depends on MCP SDK</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>    <span class="n">server_did</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>    <span class="n">server_badge</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>    <span class="c1"># If we get _meta from initialize response:</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>    <span class="c1"># server_did, server_badge = parse_jsonrpc_meta(init_result.meta)</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>    <span class="c1"># Verify server identity</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">verify_server</span><span class="p">(</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>        <span class="n">server_did</span><span class="o">=</span><span class="n">server_did</span><span class="p">,</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>        <span class="n">server_badge</span><span class="o">=</span><span class="n">server_badge</span><span class="p">,</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>        <span class="n">transport_origin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server_url</span><span class="p">,</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>        <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_config</span><span class="p">,</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>    <span class="p">)</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>    <span class="c1"># Enforce requirements</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_on_unverified</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">UNVERIFIED_ORIGIN</span><span class="p">:</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>        <span class="k">raise</span> <span class="n">ServerVerifyError</span><span class="p">(</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>            <span class="n">error_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">error_code</span><span class="p">,</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Server at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_url</span><span class="si">}</span><span class="s2"> did not disclose identity&quot;</span><span class="p">,</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>            <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>        <span class="p">)</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">DECLARED_PRINCIPAL</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>        <span class="k">raise</span> <span class="n">ServerVerifyError</span><span class="p">(</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>            <span class="n">error_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">error_code</span><span class="p">,</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Server at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_url</span><span class="si">}</span><span class="s2"> did not provide verifiable badge&quot;</span><span class="p">,</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>            <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>            <span class="n">server_did</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">server_did</span><span class="p">,</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>        <span class="p">)</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>    <span class="k">if</span> <span class="p">(</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">ServerState</span><span class="o">.</span><span class="n">VERIFIED_PRINCIPAL</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">trust_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">trust_level</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>    <span class="p">):</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>        <span class="k">raise</span> <span class="n">ServerVerifyError</span><span class="p">(</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>            <span class="n">error_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">error_code</span><span class="p">,</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>            <span class="n">detail</span><span class="o">=</span><span class="p">(</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>                <span class="sa">f</span><span class="s2">&quot;Server trust level </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">trust_level</span><span class="si">}</span><span class="s2"> &quot;</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>                <span class="sa">f</span><span class="s2">&quot;is below required </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_trust_level</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>            <span class="p">),</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>            <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>            <span class="n">server_did</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">server_did</span><span class="p">,</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>        <span class="p">)</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>        <span class="sa">f</span><span class="s2">&quot;Connected to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_url</span><span class="si">}</span><span class="s2">: &quot;</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>        <span class="sa">f</span><span class="s2">&quot;state=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>        <span class="sa">f</span><span class="s2">&quot;trust_level=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_result</span><span class="o">.</span><span class="n">trust_level</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPClient.create_initialize_request_meta" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_initialize_request_meta</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create the _meta object for initialize request.</p>
<p>This should be called when building the initialize request.
It generates a PoP nonce to be signed by the server.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict to include as _meta in initialize request</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <h4 id="capiscio_mcp.integrations.mcp.CapiscioMCPClient.create_initialize_request_meta--in-your-client-code">In your client code</h4>
<p>meta = client.create_initialize_request_meta()
result = await session.initialize(
    client_info=ClientInfo(...),
    _meta=meta,
)</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/integrations/mcp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_initialize_request_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a><span class="sd">    Create the _meta object for initialize request.</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="sd">    This should be called when building the initialize request.</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="sd">    It generates a PoP nonce to be signed by the server.</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a><span class="sd">        Dict to include as _meta in initialize request</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a><span class="sd">        # In your client code</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a><span class="sd">        meta = client.create_initialize_request_meta()</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a><span class="sd">        result = await session.initialize(</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a><span class="sd">            client_info=ClientInfo(...),</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a><span class="sd">            _meta=meta,</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a><span class="sd">        )</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_request</span> <span class="o">=</span> <span class="n">generate_pop_request</span><span class="p">()</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_request</span><span class="o">.</span><span class="n">to_meta</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPClient.list_tools" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">list_tools</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>List available tools on the server.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of tool definitions</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/integrations/mcp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-679" name="__codelineno-0-679"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a><span class="sd">    List available tools on the server.</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a><span class="sd">        List of tool definitions</span>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Client not connected. Use &#39;async with&#39; context.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>    <span class="c1"># List tools via MCP client</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>    <span class="c1"># Implementation depends on MCP SDK</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>    <span class="k">return</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPClient.verify_initialize_response" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">verify_initialize_response</span><span class="p">(</span><span class="n">response_meta</span><span class="p">,</span> <span class="n">server_public_key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Verify the initialize response including PoP.</p>
<p>This should be called after receiving the initialize response.
It extracts the PoP signature and verifies it.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>response_meta</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The _meta from initialize response</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>server_public_key</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[&#39;Ed25519PublicKey&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server's public key for PoP verification
              (if None, will try to extract from did:key)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if PoP verification succeeded, False otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="PoPSignatureError (capiscio_mcp.pop.PoPSignatureError)" href="#capiscio_mcp.pop.PoPSignatureError">PoPSignatureError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If PoP verification fails and require_pop=True</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/integrations/mcp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-464" name="__codelineno-0-464"></a><span class="k">def</span><span class="w"> </span><span class="nf">verify_initialize_response</span><span class="p">(</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>    <span class="n">response_meta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>    <span class="n">server_public_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Ed25519PublicKey&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a><span class="sd">    Verify the initialize response including PoP.</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a><span class="sd">    This should be called after receiving the initialize response.</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a><span class="sd">    It extracts the PoP signature and verifies it.</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a><span class="sd">        response_meta: The _meta from initialize response</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a><span class="sd">        server_public_key: Server&#39;s public key for PoP verification</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a><span class="sd">                          (if None, will try to extract from did:key)</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a><span class="sd">        True if PoP verification succeeded, False otherwise</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a><span class="sd">        PoPSignatureError: If PoP verification fails and require_pop=True</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>    <span class="k">if</span> <span class="n">response_meta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No _meta in initialize response&quot;</span><span class="p">)</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>    <span class="c1"># Extract PoP response</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_response</span> <span class="o">=</span> <span class="n">PoPResponse</span><span class="o">.</span><span class="n">from_meta</span><span class="p">(</span><span class="n">response_meta</span><span class="p">)</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No PoP response in initialize response&quot;</span><span class="p">)</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;PoP response received but no request was sent&quot;</span><span class="p">)</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>    <span class="c1"># Get public key for verification</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>    <span class="k">if</span> <span class="n">server_public_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>        <span class="c1"># Try to extract from server DID</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>        <span class="n">server_did</span> <span class="o">=</span> <span class="n">response_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capiscio_server_did&quot;</span><span class="p">)</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>        <span class="k">if</span> <span class="n">server_did</span> <span class="ow">and</span> <span class="n">server_did</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;did:key:&quot;</span><span class="p">):</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>                <span class="n">server_public_key</span> <span class="o">=</span> <span class="n">extract_public_key_from_did_key</span><span class="p">(</span><span class="n">server_did</span><span class="p">)</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to extract public key from DID: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_pop</span><span class="p">:</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>                    <span class="k">raise</span> <span class="n">PoPSignatureError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot extract public key from </span><span class="si">{</span><span class="n">server_did</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>                <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>            <span class="c1"># For did:web, we&#39;d need to fetch DID document</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot verify PoP for non-did:key: </span><span class="si">{</span><span class="n">server_did</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>    <span class="c1"># Verify PoP</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>        <span class="n">verify_pop_response</span><span class="p">(</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>            <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pop_request</span><span class="p">,</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>            <span class="n">response</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pop_response</span><span class="p">,</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>            <span class="n">public_key</span><span class="o">=</span><span class="n">server_public_key</span><span class="p">,</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>        <span class="p">)</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pop_verified</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PoP verification succeeded&quot;</span><span class="p">)</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>    <span class="k">except</span> <span class="n">PoPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PoP verification failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_pop</span><span class="p">:</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>            <span class="k">raise</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="capiscio_mcp.integrations.mcp.CapiscioMCPServer" class="doc doc-heading">
            <code>CapiscioMCPServer</code>


</h2>


    <div class="doc doc-contents ">



        <p>MCP Server with CapiscIO identity disclosure, PoP signing, and tool guarding.</p>
<p>This class wraps an MCP Server to:
1. Automatically inject identity into initialize response _meta
2. Sign PoP challenges to prove key ownership (RFC-007)
3. Guard registered tools with @guard decorator</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.integrations.mcp.CapiscioMCPServer.name">name</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server name</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.integrations.mcp.CapiscioMCPServer.did">did</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server DID (did:web:... or did:key:...)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.integrations.mcp.CapiscioMCPServer.badge">badge</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server trust badge JWS (optional but recommended)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="capiscio_mcp.integrations.mcp.CapiscioMCPServer.default_min_trust_level">default_min_trust_level</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Default minimum trust level for tools</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="pop_enabled

  
      property
   (capiscio_mcp.integrations.mcp.CapiscioMCPServer.pop_enabled)" href="#capiscio_mcp.integrations.mcp.CapiscioMCPServer.pop_enabled">pop_enabled</a></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether PoP signing is available</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>server = CapiscioMCPServer(
    name="filesystem",
    did="did:web:mcp.example.com:servers:filesystem",
    badge=os.environ.get("SERVER_BADGE"),
    private_key_path="/path/to/server.key.pem",
)</p>
<p>@server.tool(min_trust_level=2)
async def read_file(path: str) -&gt; str:
    with open(path) as f:
        return f.read()</p>
<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPServer--run-the-server">Run the server</h3>
<p>await server.run_stdio()</p>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>capiscio_mcp/integrations/mcp.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="k">class</span><span class="w"> </span><span class="nc">CapiscioMCPServer</span><span class="p">:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">    MCP Server with CapiscIO identity disclosure, PoP signing, and tool guarding.</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">    This class wraps an MCP Server to:</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">    1. Automatically inject identity into initialize response _meta</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">    2. Sign PoP challenges to prove key ownership (RFC-007)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">    3. Guard registered tools with @guard decorator</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">        name: Server name</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">        did: Server DID (did:web:... or did:key:...)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">        badge: Server trust badge JWS (optional but recommended)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">        default_min_trust_level: Default minimum trust level for tools</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">        pop_enabled: Whether PoP signing is available</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">        server = CapiscioMCPServer(</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">            name=&quot;filesystem&quot;,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">            did=&quot;did:web:mcp.example.com:servers:filesystem&quot;,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">            badge=os.environ.get(&quot;SERVER_BADGE&quot;),</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">            private_key_path=&quot;/path/to/server.key.pem&quot;,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">        )</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">        @server.tool(min_trust_level=2)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">        async def read_file(path: str) -&gt; str:</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">            with open(path) as f:</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">                return f.read()</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">        # Run the server</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">        await server.run_stdio()</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="n">did</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="n">badge</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="n">default_min_trust_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="n">private_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Ed25519PrivateKey&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="n">private_key_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="n">private_key_pem</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="n">key_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>    <span class="p">):</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">        Initialize CapiscIO MCP Server.</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">            name: Server name (shown to clients)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">            did: Server DID for identity disclosure</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">            badge: Server badge JWS for identity verification</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">            default_min_trust_level: Default minimum trust level for tools</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">            version: Server version string</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">            private_key: Ed25519 private key for PoP signing (optional)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">            private_key_path: Path to PEM file containing private key (optional)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">            private_key_pem: PEM-encoded private key string/bytes (optional)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">            key_id: Key ID for JWS header (defaults to DID#keys-1)</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="n">_require_mcp_server</span><span class="p">()</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">did</span> <span class="o">=</span> <span class="n">did</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">badge</span> <span class="o">=</span> <span class="n">badge</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">default_min_trust_level</span> <span class="o">=</span> <span class="n">default_min_trust_level</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="c1"># Load private key for PoP signing</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_private_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Ed25519PrivateKey&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_key_id</span> <span class="o">=</span> <span class="n">key_id</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">did</span><span class="si">}</span><span class="s2">#keys-1&quot;</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="k">if</span> <span class="n">private_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_private_key</span> <span class="o">=</span> <span class="n">private_key</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="k">elif</span> <span class="n">private_key_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_load_private_key_from_file</span><span class="p">(</span><span class="n">private_key_path</span><span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="k">elif</span> <span class="n">private_key_pem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_private_key</span> <span class="o">=</span> <span class="n">load_private_key_from_pem</span><span class="p">(</span><span class="n">private_key_pem</span><span class="p">)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="o">=</span> <span class="n">McpServer</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tool_configs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">GuardConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_identity_injection</span><span class="p">()</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_load_private_key_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load private key from PEM file.&quot;&quot;&quot;</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">CRYPTO_AVAILABLE</span><span class="p">:</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                <span class="s2">&quot;PoP signing requires &#39;cryptography&#39; package. &quot;</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                <span class="s2">&quot;Install with: pip install capiscio-mcp[crypto]&quot;</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>            <span class="k">return</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                <span class="n">pem_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_private_key</span> <span class="o">=</span> <span class="n">load_private_key_from_pem</span><span class="p">(</span><span class="n">pem_data</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded private key from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load private key from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pop_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if PoP signing is available.&quot;&quot;&quot;</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_identity_injection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a><span class="sd">        Set up identity injection into initialize response.</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="sd">        Per RFC-007 6.2, server identity is disclosed via _meta in</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a><span class="sd">        the initialize response.</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="c1"># The MCP SDK provides hooks for customizing responses</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="c1"># This implementation depends on the specific MCP SDK version</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="c1"># For now, we&#39;ll store the identity info to be included</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_identity_meta</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>            <span class="s2">&quot;capiscio_server_did&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">did</span><span class="p">,</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="p">}</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">badge</span><span class="p">:</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_identity_meta</span><span class="p">[</span><span class="s2">&quot;capiscio_server_badge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">badge</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_initialize_response_meta</span><span class="p">(</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="n">request_meta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="sd">        Create the _meta object for initialize response.</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">        This method should be called when building the initialize response.</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">        It includes:</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">        1. Server identity (DID, badge)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">        2. PoP response (if client sent PoP request and we have a private key)</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="sd">            request_meta: The _meta from the initialize request (for PoP)</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">            Dict to include as _meta in initialize response</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">        Example:</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">            # In your initialize handler</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">            def handle_initialize(request):</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">                response_meta = server.create_initialize_response_meta(</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><span class="sd">                    request_meta=request.params.get(&quot;_meta&quot;)</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">                )</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="sd">                return InitializeResult(</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">                    capabilities=...,</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">                    _meta=response_meta,</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="sd">                )</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identity_meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="c1"># Handle PoP if client sent nonce and we have a key</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">request_meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>            <span class="n">pop_request</span> <span class="o">=</span> <span class="n">PoPRequest</span><span class="o">.</span><span class="n">from_meta</span><span class="p">(</span><span class="n">request_meta</span><span class="p">)</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="k">if</span> <span class="n">pop_request</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                    <span class="n">pop_response</span> <span class="o">=</span> <span class="n">create_pop_response</span><span class="p">(</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                        <span class="n">request</span><span class="o">=</span><span class="n">pop_request</span><span class="p">,</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                        <span class="n">private_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_private_key</span><span class="p">,</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                        <span class="n">key_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_id</span><span class="p">,</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                    <span class="p">)</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                    <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pop_response</span><span class="o">.</span><span class="n">to_meta</span><span class="p">())</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added PoP signature to initialize response&quot;</span><span class="p">)</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create PoP response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>        <span class="k">return</span> <span class="n">meta</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tool</span><span class="p">(</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>        <span class="n">min_trust_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GuardConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">T</span><span class="p">]]],</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">T</span><span class="p">]]]:</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">        Register a tool with CapiscIO guard.</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a><span class="sd">        This decorator:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a><span class="sd">        1. Registers the function as an MCP tool</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="sd">        2. Wraps it with @guard for access control</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">            name: Tool name (default: function name)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a><span class="sd">            description: Tool description</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="sd">            min_trust_level: Minimum trust level (overrides default)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="sd">            config: Full guard configuration</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="sd">            Decorator function</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="sd">        Example:</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">            @server.tool(min_trust_level=2)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><span class="sd">            async def execute_query(sql: str) -&gt; list[dict]:</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">                ...</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>            <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">T</span><span class="p">]]</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">T</span><span class="p">]]:</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>            <span class="n">tool_name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>            <span class="n">tool_description</span> <span class="o">=</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;Tool: </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="c1"># Build effective config</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>            <span class="n">effective_config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">GuardConfig</span><span class="p">()</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>            <span class="k">if</span> <span class="n">min_trust_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>                <span class="n">effective_config</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">=</span> <span class="n">min_trust_level</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>            <span class="k">elif</span> <span class="n">effective_config</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>                <span class="n">effective_config</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_min_trust_level</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>            <span class="c1"># Apply guard decorator</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>            <span class="n">guarded_func</span> <span class="o">=</span> <span class="n">guard</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">effective_config</span><span class="p">,</span> <span class="n">tool_name</span><span class="o">=</span><span class="n">tool_name</span><span class="p">)(</span><span class="n">func</span><span class="p">)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="c1"># Store for registration</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">tool_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">guarded_func</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_tool_configs</span><span class="p">[</span><span class="n">tool_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">effective_config</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>            <span class="c1"># Register with MCP server</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>            <span class="c1"># Note: Registration API depends on MCP SDK version</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>            <span class="c1"># This is a placeholder for the actual registration</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Registered tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39; with trust level </span><span class="si">{</span><span class="n">effective_config</span><span class="o">.</span><span class="n">min_trust_level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>            <span class="k">return</span> <span class="n">guarded_func</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>        <span class="k">return</span> <span class="n">decorator</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">server</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;McpServer&quot;</span><span class="p">:</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Access the underlying MCP server.&quot;&quot;&quot;</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">identity_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the identity metadata for initialize response.&quot;&quot;&quot;</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identity_meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_stdio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the server over stdio transport.&quot;&quot;&quot;</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>        <span class="c1"># Implementation depends on MCP SDK</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="k">pass</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_sse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8080</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the server over SSE transport.&quot;&quot;&quot;</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="c1"># Implementation depends on MCP SDK</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPServer.identity_meta" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">identity_meta</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Get the identity metadata for initialize response.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPServer.pop_enabled" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pop_enabled</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Check if PoP signing is available.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPServer.server" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">server</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Access the underlying MCP server.</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPServer.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">did</span><span class="p">,</span> <span class="n">badge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_min_trust_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1.0.0&#39;</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">private_key_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">private_key_pem</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize CapiscIO MCP Server.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server name (shown to clients)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>did</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server DID for identity disclosure</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>badge</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server badge JWS for identity verification</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>default_min_trust_level</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Default minimum trust level for tools</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>version</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Server version string</p>
              </div>
            </td>
            <td>
                  <code>&#39;1.0.0&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>private_key</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[&#39;Ed25519PrivateKey&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ed25519 private key for PoP signing (optional)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>private_key_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to PEM file containing private key (optional)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>private_key_pem</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bytes">bytes</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PEM-encoded private key string/bytes (optional)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>key_id</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Key ID for JWS header (defaults to DID#keys-1)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/integrations/mcp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="n">did</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="n">badge</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="n">default_min_trust_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>    <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>    <span class="n">private_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Ed25519PrivateKey&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="n">private_key_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>    <span class="n">private_key_pem</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="n">key_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="p">):</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">    Initialize CapiscIO MCP Server.</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">        name: Server name (shown to clients)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">        did: Server DID for identity disclosure</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">        badge: Server badge JWS for identity verification</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">        default_min_trust_level: Default minimum trust level for tools</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">        version: Server version string</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">        private_key: Ed25519 private key for PoP signing (optional)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">        private_key_path: Path to PEM file containing private key (optional)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">        private_key_pem: PEM-encoded private key string/bytes (optional)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">        key_id: Key ID for JWS header (defaults to DID#keys-1)</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="n">_require_mcp_server</span><span class="p">()</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">did</span> <span class="o">=</span> <span class="n">did</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">badge</span> <span class="o">=</span> <span class="n">badge</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">default_min_trust_level</span> <span class="o">=</span> <span class="n">default_min_trust_level</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="c1"># Load private key for PoP signing</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_private_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Ed25519PrivateKey&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_key_id</span> <span class="o">=</span> <span class="n">key_id</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">did</span><span class="si">}</span><span class="s2">#keys-1&quot;</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>    <span class="k">if</span> <span class="n">private_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_private_key</span> <span class="o">=</span> <span class="n">private_key</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="k">elif</span> <span class="n">private_key_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_load_private_key_from_file</span><span class="p">(</span><span class="n">private_key_path</span><span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>    <span class="k">elif</span> <span class="n">private_key_pem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_private_key</span> <span class="o">=</span> <span class="n">load_private_key_from_pem</span><span class="p">(</span><span class="n">private_key_pem</span><span class="p">)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="o">=</span> <span class="n">McpServer</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_tool_configs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">GuardConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_setup_identity_injection</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPServer.create_initialize_response_meta" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_initialize_response_meta</span><span class="p">(</span><span class="n">request_meta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create the _meta object for initialize response.</p>
<p>This method should be called when building the initialize response.
It includes:
1. Server identity (DID, badge)
2. PoP response (if client sent PoP request and we have a private key)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>request_meta</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The _meta from the initialize request (for PoP)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict to include as _meta in initialize response</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <h4 id="capiscio_mcp.integrations.mcp.CapiscioMCPServer.create_initialize_response_meta--in-your-initialize-handler">In your initialize handler</h4>
<p>def handle_initialize(request):
    response_meta = server.create_initialize_response_meta(
        request_meta=request.params.get("_meta")
    )
    return InitializeResult(
        capabilities=...,
        _meta=response_meta,
    )</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/integrations/mcp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-241" name="__codelineno-0-241"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_initialize_response_meta</span><span class="p">(</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="n">request_meta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="sd">    Create the _meta object for initialize response.</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">    This method should be called when building the initialize response.</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">    It includes:</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">    1. Server identity (DID, badge)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">    2. PoP response (if client sent PoP request and we have a private key)</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="sd">        request_meta: The _meta from the initialize request (for PoP)</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">        Dict to include as _meta in initialize response</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">        # In your initialize handler</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">        def handle_initialize(request):</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">            response_meta = server.create_initialize_response_meta(</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><span class="sd">                request_meta=request.params.get(&quot;_meta&quot;)</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">            )</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="sd">            return InitializeResult(</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">                capabilities=...,</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">                _meta=response_meta,</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="sd">            )</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>    <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identity_meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="c1"># Handle PoP if client sent nonce and we have a key</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">request_meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="n">pop_request</span> <span class="o">=</span> <span class="n">PoPRequest</span><span class="o">.</span><span class="n">from_meta</span><span class="p">(</span><span class="n">request_meta</span><span class="p">)</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="k">if</span> <span class="n">pop_request</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                <span class="n">pop_response</span> <span class="o">=</span> <span class="n">create_pop_response</span><span class="p">(</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                    <span class="n">request</span><span class="o">=</span><span class="n">pop_request</span><span class="p">,</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                    <span class="n">private_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_private_key</span><span class="p">,</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                    <span class="n">key_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_id</span><span class="p">,</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                <span class="p">)</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pop_response</span><span class="o">.</span><span class="n">to_meta</span><span class="p">())</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added PoP signature to initialize response&quot;</span><span class="p">)</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create PoP response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="k">return</span> <span class="n">meta</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPServer.run_sse" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_sse</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Run the server over SSE transport.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/integrations/mcp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_sse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8080</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the server over SSE transport.&quot;&quot;&quot;</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>    <span class="c1"># Implementation depends on MCP SDK</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPServer.run_stdio" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_stdio</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Run the server over stdio transport.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/integrations/mcp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-356" name="__codelineno-0-356"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_stdio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the server over stdio transport.&quot;&quot;&quot;</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>    <span class="c1"># Implementation depends on MCP SDK</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="capiscio_mcp.integrations.mcp.CapiscioMCPServer.tool" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">tool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_trust_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Register a tool with CapiscIO guard.</p>
<p>This decorator:
1. Registers the function as an MCP tool
2. Wraps it with @guard for access control</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tool name (default: function name)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>description</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tool description</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_trust_level</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum trust level (overrides default)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="GuardConfig


  
      dataclass
   (capiscio_mcp.guard.GuardConfig)" href="#capiscio_mcp.guard.GuardConfig">GuardConfig</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Full guard configuration</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<span title="typing.Callable">Callable</span>[..., <span title="typing.Coroutine">Coroutine</span>[<span title="typing.Any">Any</span>, <span title="typing.Any">Any</span>, <span title="capiscio_mcp.integrations.mcp.T">T</span>]]], <span title="typing.Callable">Callable</span>[..., <span title="typing.Coroutine">Coroutine</span>[<span title="typing.Any">Any</span>, <span title="typing.Any">Any</span>, <span title="capiscio_mcp.integrations.mcp.T">T</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Decorator function</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>@server.tool(min_trust_level=2)
async def execute_query(sql: str) -&gt; list[dict]:
    ...</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>capiscio_mcp/integrations/mcp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="k">def</span><span class="w"> </span><span class="nf">tool</span><span class="p">(</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="n">min_trust_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GuardConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">T</span><span class="p">]]],</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">T</span><span class="p">]]]:</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">    Register a tool with CapiscIO guard.</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a><span class="sd">    This decorator:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a><span class="sd">    1. Registers the function as an MCP tool</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="sd">    2. Wraps it with @guard for access control</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">        name: Tool name (default: function name)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a><span class="sd">        description: Tool description</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="sd">        min_trust_level: Minimum trust level (overrides default)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="sd">        config: Full guard configuration</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="sd">        Decorator function</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">        @server.tool(min_trust_level=2)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><span class="sd">        async def execute_query(sql: str) -&gt; list[dict]:</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">            ...</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">T</span><span class="p">]]</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">T</span><span class="p">]]:</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="n">tool_name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="n">tool_description</span> <span class="o">=</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;Tool: </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="c1"># Build effective config</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="n">effective_config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">GuardConfig</span><span class="p">()</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="k">if</span> <span class="n">min_trust_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>            <span class="n">effective_config</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">=</span> <span class="n">min_trust_level</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="k">elif</span> <span class="n">effective_config</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="n">effective_config</span><span class="o">.</span><span class="n">min_trust_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_min_trust_level</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="c1"># Apply guard decorator</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="n">guarded_func</span> <span class="o">=</span> <span class="n">guard</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">effective_config</span><span class="p">,</span> <span class="n">tool_name</span><span class="o">=</span><span class="n">tool_name</span><span class="p">)(</span><span class="n">func</span><span class="p">)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>        <span class="c1"># Store for registration</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tools</span><span class="p">[</span><span class="n">tool_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">guarded_func</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tool_configs</span><span class="p">[</span><span class="n">tool_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">effective_config</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>        <span class="c1"># Register with MCP server</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>        <span class="c1"># Note: Registration API depends on MCP SDK version</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>        <span class="c1"># This is a placeholder for the actual registration</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Registered tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39; with trust level </span><span class="si">{</span><span class="n">effective_config</span><span class="o">.</span><span class="n">min_trust_level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>        <span class="k">return</span> <span class="n">guarded_func</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>    <span class="k">return</span> <span class="n">decorator</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 CapiscIO
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.tabs", "navigation.sections", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>